<!doctype html>
</main>


<script>
const listEl = utils.qs('#list');
const emptyEl = utils.qs('#empty');
const qEl = utils.qs('#q');
const catEl = utils.qs('#cat');


async function loadCategories(){
const { data } = await supabaseClient.from('categories').select('id,name').order('name');
catEl.innerHTML = `<option value="">Всички категории</option>` + (data||[]).map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
}


async function search(){
const q = qEl.value.trim();
const cat = catEl.value;
let query = supabaseClient.from('ads').select('id,title,price,created_at,ad_images(url,position)').eq('status','approved').order('created_at', { ascending: false });
if(cat) query = query.eq('category_id', cat);
const { data, error } = await query;
if(error){ console.error(error); return; }
let rows = data;
if(q){
const qq = q.toLowerCase();
rows = rows.filter(r => r.title?.toLowerCase().includes(qq)); // за MVP филтър в клиента
}
render(rows);
}


function card(ad){
const thumb = (ad.ad_images||[]).sort((a,b)=>a.position-b.position)[0]?.url || 'https://placehold.co/400x240?text=NovaObqva';
return `
<a href="ad.html?id=${ad.id}" class="group bg-white rounded-2xl border shadow-sm overflow-hidden hover:shadow-md transition">
<div class="aspect-video bg-slate-100"><img src="${thumb}" alt="" class="w-full h-full object-cover" loading="lazy"></div>
<div class="p-4">
<div class="flex items-center justify-between gap-2">
<h3 class="font-semibold line-clamp-1">${ad.title}</h3>
<div class="text-emerald-700 font-bold whitespace-nowrap">${utils.money(ad.price)}</div>
</div>
<div class="text-sm text-slate-500 mt-1">Публикувана: ${new Date(ad.created_at).toLocaleDateString('bg-BG')}</div>
</div>
</a>`;
}


function render(rows){
if(!rows || rows.length===0){ listEl.innerHTML=''; emptyEl.classList.remove('hidden'); return; }
emptyEl.classList.add('hidden');
listEl.innerHTML = rows.map(card).join('');
}


utils.qs('#searchBtn').addEventListener('click', search);
loadCategories().then(search);
</script>
</body>
</html>
