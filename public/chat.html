<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NovaObqva — Чат</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="env.js"></script>
  <style>
    body{background:
      radial-gradient(1200px 600px at -10% -10%, rgba(244,114,182,.10), transparent 60%),
      radial-gradient(1000px 600px at 120% 20%, rgba(99,102,241,.10), transparent 60%),
      #fff;}
    .shell{max-width:960px;margin:0 auto}
    .bubble{max-width:80%;padding:.6rem .8rem;border-radius:14px;border:1px solid #e5e7eb;background:#fff}
    .bubble.me{background:#f0f9ff;border-color:#bae6fd}
    .msg-row{display:flex;gap:.5rem;margin:.35rem 0}
    .msg-row.me{justify-content:flex-end}
    .scroll{scroll-behavior:smooth}
  </style>
</head>
<body class="min-h-screen">
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b">
    <div class="shell px-4 py-3 flex items-center gap-3">
      <a href="/" class="flex items-center gap-2">
        <img src="favicon.png" class="w-7 h-7 rounded" alt="">
        <strong>NovaObqva</strong>
      </a>
      <div class="flex-1"></div>
      <a href="index.html" class="px-3 py-1.5 rounded-lg border bg-white hover:bg-slate-50 text-sm">Обяви</a>
    </div>
  </header>

  <main class="shell px-4">
    <section id="head" class="mt-4 mb-3 rounded-xl border bg-white p-3 flex items-center justify-between">
      <div>
        <div id="convTitle" class="font-bold">Чат</div>
        <div id="convMeta" class="text-sm text-slate-500">Зареждане…</div>
      </div>
      <div class="flex items-center gap-2">
        <a id="openAd" href="#" class="px-3 py-1.5 rounded-lg border bg-white hover:bg-slate-50 text-sm hidden">Към обявата</a>
      </div>
    </section>

    <section class="rounded-xl border bg-white h-[calc(100vh-260px)] md:h-[calc(100vh-240px)] flex flex-col">
      <div id="list" class="flex-1 overflow-y-auto p-3 scroll"></div>
      <form id="composer" class="border-t p-2 flex items-end gap-2">
        <textarea id="msg" rows="1" placeholder="Напишете съобщение…" class="flex-1 resize-none rounded-lg border px-3 py-2"></textarea>
        <input id="offer" type="number" step="0.01" min="0" placeholder="Оферта (лв.)" class="w-36 rounded-lg border px-3 py-2">
        <button class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Изпрати</button>
      </form>
    </section>
  </main>

  <script>
    const sb = supabase.createClient(window.ENV.SUPABASE_URL, window.ENV.SUPABASE_ANON_KEY);

    const elList = document.getElementById('list');
    const elMsg  = document.getElementById('msg');
    const elOffer= document.getElementById('offer');
    const elTitle= document.getElementById('convTitle');
    const elMeta = document.getElementById('convMeta');
    const elOpenAd = document.getElementById('openAd');

    const qs = new URLSearchParams(location.search);
    const qId  = qs.get('id');    // conversation id
    const qAd  = qs.get('ad');    // ad id
    const qTo  = qs.get('to');    // other user id
    const qMsg = qs.get('msg') || '';
    const qOffer = qs.get('offer') || '';

    let currentUser = null;
    let convId = qId || null;
    let adId = null;

    function fmtTime(ts){
      try{ return new Date(ts).toLocaleString('bg-BG'); }catch{ return ts; }
    }
    function esc(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    function renderMessage(m){
      const me = (m.sender_id === currentUser?.id);
      const row = document.createElement('div');
      row.className = 'msg-row ' + (me ? 'me' : '');
      const b = document.createElement('div');
      b.className = 'bubble ' + (me ? 'me' : '');
      b.innerHTML = `
        <div class="text-sm">${esc(m.body || '')}${m.offer_amount? ` <span class="text-xs text-emerald-700">(оферта: ${Number(m.offer_amount).toFixed(2)} лв.)</span>`:''}</div>
        <div class="text-[11px] text-slate-400 mt-0.5">${fmtTime(m.created_at)}</div>
      `;
      row.appendChild(b);
      elList.appendChild(row);
    }

    function scrollBottom(){ elList.scrollTop = elList.scrollHeight + 999; }

    async function mustAuth(){
      const { data:{ user } } = await sb.auth.getUser();
      if (!user){
        const back = encodeURIComponent(location.href);
        location.href = `auth.html?redirectTo=${back}`;
        return null;
      }
      currentUser = user;
      return user;
    }

    async function ensureConversationFromParams(){
      // Ако вече имаме id → нищо
      if (convId) return convId;

      // Няма id, но имаме ad & to → извикваме RPC и пренасочваме
      if (qAd && qTo){
        try{
          const { data, error } = await sb.rpc('ensure_conversation', { p_ad_id: qAd, p_other_user: qTo });
          if (error) throw error;
          const params = new URLSearchParams({ id: data });
          if (qMsg) params.set('prefill', qMsg);
          if (qOffer) params.set('prefOffer', qOffer);
          location.replace('chat.html?' + params.toString());
          return null; // execution continues on next load
        }catch(e){
          console.error('ensure_conversation failed:', e);
          alert('Грешка при стартиране на разговора: ' + (e?.message || e));
        }
      }else{
        elMeta.textContent = 'Липсват параметри на разговора.';
      }
      return null;
    }

    async function loadConversationHeader(){
      // ВЗЕМИ АД/МИНИМУМ ДАННИ ЗА ЗАГЛАВИЕТО (ако имаш view — смени тук)
      try{
        // ако имаш conversations.ad_id → вземи го
        const { data:conv, error:cErr } = await sb
          .from('conversations')
          .select('id, ad_id, last_message_at')
          .eq('id', convId).maybeSingle();
        if (cErr) throw cErr;

        adId = conv?.ad_id || null;

        elTitle.textContent = 'Разговор #' + convId.slice(0,8);
        elMeta.textContent = conv?.last_message_at
          ? ('Последно: ' + fmtTime(conv.last_message_at))
          : 'Стартиран разговор';

        if (adId){
          elOpenAd.classList.remove('hidden');
          elOpenAd.href = 'ad.html?id=' + encodeURIComponent(adId);
        }
      }catch(e){
        console.warn(e);
      }
    }

    async function loadMessages(){
      // СМЕНИ имената и колоните според твоята messages таблица
      const { data, error } = await sb
        .from('messages')
        .select('id, conversation_id, sender_id, body, offer_amount, created_at')
        .eq('conversation_id', convId)
        .order('created_at', { ascending: true })
        .limit(500);
      if (error){ console.error(error); return; }

      elList.innerHTML = '';
      (data||[]).forEach(renderMessage);
      scrollBottom();
    }

    // Realtime (Postgres Changes)
    let channel = null;
    function subscribeRealtime(){
      if (channel) sb.removeChannel(channel);
      channel = sb.channel('conv_'+convId)
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'messages',
          filter: `conversation_id=eq.${convId}`
        }, payload => {
          renderMessage(payload.new);
          scrollBottom();
        })
        .subscribe((status) => {
          if (status === 'SUBSCRIBED') {
            // ok
          }
        });
    }

    async function sendMessage(body, offerAmount){
      if (!body && !offerAmount) return;
      // СМЕНИ имената/колоните според твоята messages таблица
      const { error } = await sb.from('messages').insert({
        conversation_id: convId,
        sender_id: currentUser.id,
        body: body || null,
        offer_amount: offerAmount ? Number(offerAmount) : null
      });
      if (error){
        console.error(error);
        alert('Неуспешно изпращане: ' + (error.message || error));
      }else{
        elMsg.value = '';
        elOffer.value = '';
      }
    }

    // Адаптивен composer (auto-resize)
    elMsg.addEventListener('input', ()=>{
      elMsg.style.height = 'auto';
      elMsg.style.height = Math.min(elMsg.scrollHeight, 160) + 'px';
    });

    document.getElementById('composer').addEventListener('submit', (e)=>{
      e.preventDefault();
      sendMessage(elMsg.value.trim(), elOffer.value.trim());
    });

    // -------- ИНИТ --------
    (async () => {
      const me = await mustAuth();
      if (!me) return;

      const ensured = await ensureConversationFromParams();
      if (ensured === null && !qId) return; // ще се зареди след redirect
      convId = ensured || qId;

      await loadConversationHeader();
      await loadMessages();
      subscribeRealtime();

      // Prefill ако идваме след redirect
      const prefill = new URLSearchParams(location.search).get('prefill');
      const prefOffer = new URLSearchParams(location.search).get('prefOffer');
      if (prefill){ elMsg.value = prefill; }
      if (prefOffer){ elOffer.value = prefOffer; }
    })();
  </script>
</body>
</html>
