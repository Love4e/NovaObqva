<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NovaObqva — Услуги 18+</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="styles/base.css" />
  <style>
    :root{
      --rose:#f472b6; --rose-600:#e11d48; --violet:#a78bfa;
      --ink:#0f172a; --muted:#64748b;
    }
    body{
      background:
        radial-gradient(1200px 600px at -10% -10%, rgba(244,114,182,.16), transparent 60%),
        radial-gradient(1000px 600px at 120% 20%, rgba(99,102,241,.14), transparent 60%),
        #ffffff;
    }
    .glass{background:rgba(255,255,255,.78);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
    .ring-rose-soft{box-shadow:0 0 0 1px rgba(244,114,182,.35) inset}

    /* --- Карти 18+ --- */
    .adult-card{
      border-radius:18px; overflow:hidden; border:1px solid rgba(244,114,182,.35);
      box-shadow:0 10px 24px rgba(244,114,182,.18);
      transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease;
      background:#fff;
    }
    .adult-card:hover{ transform:translateY(-2px); box-shadow:0 14px 34px rgba(244,114,182,.28); border-color:rgba(244,114,182,.55); }
    .adult-card .aspect-video img{
      filter: grayscale(.3) brightness(.98) saturate(.95) contrast(.98);
      transform: scale(1.01);
    }
    .adult-card .mat{
      position:absolute; inset:0; pointer-events:none;
      background: radial-gradient(60% 60% at 50% 40%, rgba(255,255,255,.0), rgba(255,182,193,.16)),
                  linear-gradient(180deg, rgba(255,255,255,.0), rgba(0,0,0,.10));
    }
    .adult-badge{
      position:absolute; top:10px; right:10px; z-index:10;
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 12px; border-radius:999px; font-weight:900; letter-spacing:.02em;
      background:linear-gradient(90deg,#fb7185,#f472b6); color:#fff;
      box-shadow:0 8px 22px rgba(244,114,182,.45), inset 0 0 0 1px rgba(255,255,255,.25);
    }
    .adult-badge .dot{width:10px; height:10px; border-radius:999px; background:#fff; box-shadow:0 0 0 2px rgba(255,255,255,.35)}

    /* --- Модал: публикация --- */
    .overlay{display:none; position:fixed; inset:0; z-index:70; align-items:center; justify-content:center; padding:16px;}
    .overlay.open{display:flex;}
    .overlay::before{
      content:""; position:absolute; inset:0;
      background:rgba(15,23,42,.55);
      backdrop-filter:blur(4px);
    }
    .modal{
      position:relative; z-index:1; width:min(860px,96vw);
      border-radius:18px; overflow:hidden; border:1px solid rgba(244,114,182,.35);
      background:linear-gradient(180deg,#fff6fb,#ffffff);
      box-shadow:0 30px 70px rgba(244,114,182,.32), 0 18px 40px rgba(15,23,42,.2);
      color:#0f172a;
      display:flex; flex-direction:column;
    }
    .m-head{
      padding:14px 16px; border-bottom:1px solid rgba(244,114,182,.25);
      background:linear-gradient(90deg, rgba(244,114,182,.18), rgba(167,139,250,.18));
      display:flex; align-items:center; gap:10px; justify-content:space-between;
    }
    .m-head h2{ margin:0; font-weight:900; letter-spacing:.01em }
    .m-head .hint{ color:#475569 }
    .m-body{ padding:16px; max-height:72vh; overflow:auto; }
    /* Невидим скрол за модала */
    .m-body{ scrollbar-width: none; -ms-overflow-style: none; }
    .m-body::-webkit-scrollbar{ width:0; height:0 }

    /* Елементи във формата */
    .m-body label{ display:block; font-weight:700; margin:.25rem 0 .25rem }
    .m-body input, .m-body textarea, .m-body select{
      width:100%; border:1px solid #e2e8f0; border-radius:12px; padding:.6rem .75rem;
      background:#fff; outline:0;
    }
    .m-body textarea{ min-height:120px; resize:vertical }
    .row{ display:flex; gap:12px; flex-wrap:wrap }
    .opt{
      flex:1 1 220px; border:1px solid rgba(15,23,42,.08); border-radius:14px; padding:.8rem;
      cursor:pointer; background:#fff;
    }
    .opt.active{ outline:2px solid #a78bfa; background:linear-gradient(180deg,#fff,#fbf8ff) }

    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.7rem 1rem;border-radius:12px;border:1px solid rgba(15,23,42,.12);font-weight:800}
    .btn.primary{background:linear-gradient(135deg,#22c55e,#10b981);color:#0b1220;border:1px solid rgba(255,255,255,.18)}
    .btn[aria-disabled="true"]{opacity:.55;pointer-events:none}
    .err{display:none;background:#fee2e2;border:1px solid #fecaca;color:#7f1d1d;padding:.6rem .8rem;border-radius:12px}
    .note{display:none;background:#ecfeff;border:1px solid #a5f3fc;color:#155e75;padding:.6rem .8rem;border-radius:12px}
    .thumb{display:none;width:100%;aspect-ratio:4/3;object-fit:cover;margin-top:.5rem;border-radius:10px;border:1px solid #e2e8f0}

    /* Плаващ долен десен бутон */
    .fab-publish{
      position:fixed; right:18px; bottom:22px; z-index:75;
      padding:.9rem 1.4rem; border-radius:9999px; border:0;
      color:#fff; font-weight:800; cursor:pointer;
      background:linear-gradient(135deg,#fb7185,#a78bfa);
      box-shadow:0 14px 38px rgba(244,114,182,.35), 0 8px 24px rgba(99,102,241,.25);
      transition:transform .15s ease, box-shadow .15s ease;
    }
    .fab-publish:hover{ transform:translateY(-2px); box-shadow:0 18px 50px rgba(244,114,182,.45), 0 10px 28px rgba(99,102,241,.30) }
    .fab-publish:active{ transform:translateY(0) scale(.99) }
    .fab-publish:focus-visible{ outline:3px solid rgba(167,139,250,.6); outline-offset:2px; }
    @media (max-width:480px){ .fab-publish{ right:14px; bottom:18px; padding:.8rem 1.1rem } }

    /* Грид за обявите */
    .ads-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:16px }
    .muted{ color:var(--muted) }
  </style>
</head>
<body class="min-h-screen antialiased">
  <!-- HEADER -->
  <header class="sticky top-0 z-30 glass border-b border-rose-100">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <a href="/" class="flex items-center gap-2">
        <img src="favicon.png" alt="NovaObqva" class="w-7 h-7 rounded">
        <span class="text-xl font-extrabold">NovaObqva</span>
      </a>
      <nav class="hidden md:flex items-center gap-2 ml-4">
        <a href="index.html" class="px-3 py-1.5 rounded-lg hover:bg-slate-100">Обяви</a>
        <a href="plans.html" class="px-3 py-1.5 rounded-lg hover:bg-slate-100">Планове</a>
        <span class="px-3 py-1.5 rounded-lg font-bold text-rose-600">Услуги 18+</span>
      </nav>
      <div class="flex-1"></div>
      <div id="nav-auth-desktop" class="hidden md:flex items-center gap-2"></div>
    </div>
  </header>

  <!-- HERO -->
  <section class="py-8 md:py-10">
    <div class="max-w-6xl mx-auto px-4">
      <div class="rounded-2xl p-5 md:p-7 glass border border-rose-100 shadow-[0_10px_30px_rgba(244,114,182,.12)]">
        <div class="flex items-start md:items-center justify-between gap-4 flex-col md:flex-row">
          <div>
            <h1 class="text-2xl md:text-3xl font-black tracking-tight">Услуги 18+ — селекция с визуална подчертаност</h1>
            <p class="mt-1 text-slate-600">Страницата е само за пълнолетни. Картите са матирани и маркирани с 18+.</p>
          </div>
          <div class="flex items-center gap-2">
            <img src="favicon.png" class="w-9 h-9 rounded ring-rose-soft" alt="">
            <span class="text-sm text-slate-600">Официална секция на NovaObqva</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- LIST -->
  <main class="max-w-6xl mx-auto px-4 pb-16">
    <div id="ads" class="ads-grid"></div>
    <p id="empty" class="text-center text-slate-500 hidden mt-6">Няма публикувани обяви.</p>
  </main>

  <!-- FOOTER -->
  <footer class="max-w-6xl mx-auto px-4 pb-20 text-sm text-slate-500">
    <div>© <span id="y"></span> NovaObqva · Astra18</div>
  </footer>

  <!-- Floating CTA -->
  <button id="fabPublish" class="fab-publish" type="button" aria-label="Публикувай услуга">Публикувай</button>

  <!-- Publisher Modal -->
  <div id="publishModal" class="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="m-head">
        <div>
          <h2>Публикувай услуга · 18+</h2>
          <small class="hint">Избери план · плати по външен линк · MAX = най-предни позиции</small>
        </div>
        <button class="btn" id="closePublish" title="Затвори">✕</button>
      </div>

      <div class="m-body">
        <!-- honeypot -->
        <input id="hpt" type="text" style="position:absolute;left:-9999px;opacity:0" autocomplete="off" tabindex="-1" aria-hidden="true">

        <div class="row">
          <div style="flex:2;min-width:220px">
            <label>Заглавие <span class="muted">(до 80 знака)</span></label>
            <input id="f_title" maxlength="80" placeholder="Пример: Deluxe Velvet Experience" />
          </div>
          <div style="flex:1;min-width:160px">
            <label>Цена (лв.)</label>
            <input id="f_price" type="number" min="0" step="1" placeholder="100" />
            <div id="pricePair" class="muted text-sm mt-1"></div>
          </div>
        </div>

        <label>Описание <span class="muted">(мин. 20 знака)</span></label>
        <textarea id="f_desc" minlength="20" placeholder="Кратко и ясно описание на услугата..."></textarea>

        <div class="row">
          <div style="flex:1;min-width:240px">
            <label>Снимка (URL)</label>
            <input id="f_image" placeholder="https://..." />
            <img id="thumb" class="thumb" alt="Преглед">
          </div>
          <div style="flex:1;min-width:180px">
            <label>Категория</label>
            <select id="f_cat" disabled><option selected>Услуги 18+</option></select>
          </div>
        </div>

        <!-- Контакти -->
        <div class="row">
          <div style="flex:1;min-width:200px">
            <label>Име за контакт</label>
            <input id="f_name" placeholder="Вашето име" />
          </div>
          <div style="flex:1;min-width:220px">
            <label>Имейл за контакт</label>
            <input id="f_email" type="email" placeholder="you@example.com" />
          </div>
          <div style="flex:1;min-width:180px">
            <label>Телефон</label>
            <input id="f_phone" placeholder="+359..." />
          </div>
        </div>

        <label>План</label>
        <div class="row">
          <div id="optFree" class="opt active"><b>FREE</b><br><small class="muted">Стандартна позиция (след одобрение)</small></div>
          <div id="optMax" class="opt"><b>MAX</b><br><small class="muted">Най-предни позиции (след плащане и одобрение)</small></div>
        </div>

        <div id="upsell" class="note" style="margin-top:8px;display:none">
          ❤️ При избор на <b>MAX</b> ще получиш два бутона за плащане (активни след изпращане на заявката):
          <div class="row" style="margin-top:8px">
            <a id="btnMaxBGN" class="btn" aria-disabled="true" target="_blank" rel="noopener">Купи MAX (BGN)</a>
            <a id="btnMaxEUR" class="btn" aria-disabled="true" target="_blank" rel="noopener">Купи MAX (EUR)</a>
          </div>
          <small class="muted">Линкът ще съдържа <code>ref=PID</code> за бързо одобрение.</small>
        </div>

        <div id="msg" class="err" style="margin-top:8px"></div>

        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <button id="sendAd" class="btn primary">Изпрати за одобрение</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // === Supabase клиент: env.js → fallback ===
    const SUPABASE_URL  = (window.ENV && window.ENV.SUPABASE_URL)      || "https://cmiylzpmpwqbacjoqtkx.supabase.co";
    const SUPABASE_ANON = (window.ENV && window.ENV.SUPABASE_ANON_KEY) || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtaXlsenBtcHdxYmFjam9xdGt4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5ODcwMDUsImV4cCI6MjA2OTU2MzAwNX0.FY2d1NSGTmw6SydxT_V0cKF7Kp2USbp91VdfO_eqZz8";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // Плащания за MAX
    const PAY_MAX_BGN = "https://checkout.revolut.com/payment-link/e336d64c-7c6a-4962-a7ba-0f9a0e8f3a10";
    const PAY_MAX_EUR = "https://checkout.revolut.com/payment-link/cc4190df-60c1-4f8c-9d3a-c0a949dbb527";

    const $ = s => document.querySelector(s);
    const show = el => el.style.display='block';
    const hide = el => el.style.display='none';
    document.getElementById('y').textContent = new Date().getFullYear();

    // Префил на имейл, ако е логнат
    (async () => {
      try{
        const { data:{ user } } = await sb.auth.getUser();
        if (user?.email && !document.getElementById('f_email').value) {
          document.getElementById('f_email').value = user.email;
        }
        // Header auth (кратко)
        const d = document.getElementById('nav-auth-desktop');
        d.innerHTML = user
          ? `<button id="nav-logout" class="px-3 py-1.5 rounded-lg bg-slate-800 text-white text-sm">Изход</button>`
          : `<a href="auth.html?redirectTo=${encodeURIComponent(location.href)}" class="px-3 py-1.5 rounded-lg bg-emerald-600 text-white text-sm">Вход</a>`;
        d.classList.remove('hidden');
        document.getElementById('nav-logout')?.addEventListener('click', async()=>{ await sb.auth.signOut(); location.reload(); });
      }catch(_){}
    })();

    // Витрина: одобрени 18+
    async function loadAds(){
      const empty = $('#empty');
      const list = $('#ads');
      try{
        const { data, error } = await sb
          .from('ads')
          .select('id,title,description,images,cover_image,price,plan_name,is_adult,approved_at,price_currency,plan_currency,city,category')
          .eq('ad_status','approved')
          .eq('is_adult', true)
          .order('plan_name', { ascending:false })
          .order('approved_at', { ascending:false });

        if(error) throw error;
        if(!data?.length){ show(empty); list.innerHTML=''; return; }

        hide(empty);
        list.innerHTML = data.map(ad => {
          const img = (Array.isArray(ad.images) && ad.images[0]) || ad.cover_image || 'https://placehold.co/600x340?text=NovaObqva';
          const isMax = String(ad.plan_name||'').toUpperCase()==='MAX';
          const price = ad.price ? new Intl.NumberFormat('bg-BG',{style:'currency',currency:(ad.price_currency||ad.plan_currency||'BGN')}).format(ad.price) : '';
          return `
            <article class="adult-card">
              <div class="relative aspect-video bg-slate-100">
                ${isMax ? '<div class="adult-badge" style="left:10px;right:auto"><span class="dot"></span>MAX</div>' : ''}
                <div class="adult-badge"><span class="dot"></span>18+</div>
                <div class="mat"></div>
                <img src="${img}" alt="">
              </div>
              <div class="p-4">
                <h3 class="font-semibold line-clamp-1">${(ad.title||'')}</h3>
                <p class="muted line-clamp-2 mt-1">${(ad.description||'')}</p>
                <div class="mt-2 font-bold text-emerald-700">${price}</div>
              </div>
            </article>
          `;
        }).join('');
      }catch{
        show(empty);
      }
    }
    loadAds();

    // Модал
    const PM = document.getElementById('publishModal');
    const openPublish = ()=> PM.classList.add('open');
    const closePublish = ()=> PM.classList.remove('open');
    document.getElementById('fabPublish').addEventListener('click', openPublish);
    document.getElementById('closePublish').addEventListener('click', closePublish);
    PM.addEventListener('click', (e)=>{ if (e.target === PM) closePublish(); });
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') closePublish(); });

    // План UI
    let plan='FREE', createdPid=null;
    const upsell = document.getElementById('upsell');
    document.getElementById('optFree').onclick = ()=>{ plan='FREE'; optFree.classList.add('active'); optMax.classList.remove('active'); hide(upsell); };
    document.getElementById('optMax').onclick  = ()=>{ plan='MAX';  optMax.classList.add('active');  optFree.classList.remove('active'); show(upsell); };

    // Преглед на изображение
    const thumb = document.getElementById('thumb');
    document.getElementById('f_image').addEventListener('input', () => {
      const url = document.getElementById('f_image').value.trim();
      if(/^https?:\/\/.+\.(png|jpe?g|gif|webp|avif)$/i.test(url)){ thumb.src=url; thumb.style.display='block'; }
      else { thumb.style.display='none'; }
    });

    // BGN/EUR live под цената
    const FX = 1.95583; // 1 EUR = 1.95583 BGN
    const pricePair = document.getElementById('pricePair');
    document.getElementById('f_price').addEventListener('input', ()=>{
      const v = parseFloat(document.getElementById('f_price').value);
      if(isNaN(v) || v<0){ pricePair.textContent=''; return; }
      const eur = v/FX;
      try{
        const bg = new Intl.NumberFormat('bg-BG',{style:'currency',currency:'BGN'}).format(v);
        const eu = new Intl.NumberFormat('bg-BG',{style:'currency',currency:'EUR'}).format(eur);
        pricePair.innerHTML = `${bg} <span class="mx-1 text-slate-400">•</span> ${eu}`;
      }catch(_){
        pricePair.textContent = `${v.toFixed(2)} BGN • ${(eur).toFixed(2)} EUR`;
      }
    });

    // Изпращане към ads (pending + is_adult)
    async function submitAd(){
      const msg = document.getElementById('msg');
      msg.style.display='none'; msg.className='err'; msg.textContent='';
      if(document.getElementById('hpt').value){ return; } // honeypot

      const title = document.getElementById('f_title').value.trim();
      const priceRaw = document.getElementById('f_price').value.trim();
      const price = priceRaw? Number(priceRaw) : null;
      const description = document.getElementById('f_desc').value.trim();
      const image_url = document.getElementById('f_image').value.trim();
      const contact_name = document.getElementById('f_name').value.trim();
      const contact_email = document.getElementById('f_email').value.trim();
      const contact_phone = document.getElementById('f_phone').value.trim();

      if(title.length<3 || description.length<20){
        msg.textContent='Попълни валидни заглавие (мин. 3) и описание (мин. 20).'; show(msg); return;
      }
      if(price!==null && (!isFinite(price)||price<0)){ msg.textContent='Невалидна цена.'; show(msg); return; }
      if(!contact_email){ msg.textContent='Имейл за контакт е задължителен.'; show(msg); return; }

      const plan_name = plan; // 'FREE' или 'MAX'
      const plan_currency = 'BGN';
      const plan_price = plan==='MAX' ? 39.99 : 0;
      const payment_status = 'unpaid';

      let posted_by_email = null;
      try { const { data:{ user } } = await sb.auth.getUser(); posted_by_email = user?.email || null; } catch {}

      const payload = {
        title, description, price, category: 'Услуги 18+', city: null,
        images: image_url ? [image_url] : null, cover_image: image_url || null,
        plan_name, plan_currency, plan_price, payment_status,
        contact_name: contact_name || null, contact_email, contact_phone: contact_phone || null,
        posted_by_email, is_adult: true, ad_status: 'pending'
      };

      try{
        const { data, error } = await sb.from('ads').insert(payload).select('id').single();
        if(error) throw error;
        const pid = data.id; createdPid = pid;

        // Активирай MAX линковете (след изпращане)
        document.getElementById('btnMaxBGN').href = `${PAY_MAX_BGN}?ref=${encodeURIComponent(pid)}&action=approve_max&cur=BGN`;
        document.getElementById('btnMaxEUR').href = `${PAY_MAX_EUR}?ref=${encodeURIComponent(pid)}&action=approve_max&cur=EUR`;
        document.getElementById('btnMaxBGN').setAttribute('aria-disabled','false');
        document.getElementById('btnMaxEUR').setAttribute('aria-disabled','false');

        msg.className='note';
        msg.innerHTML='Заявката е изпратена. Ако избра <b>MAX</b>, плати по линка (BGN/EUR). След плащане админът ще активира обявата и тя ще заеме първа позиция.';
        show(msg);
      }catch(e){
        msg.className='err';
        msg.textContent='Грешка при изпращане: ' + (e?.message || e);
        show(msg);
      }
    }
    document.getElementById('sendAd').onclick = submitAd;
  </script>
  <!-- env.js по желание -->
  <script src="env.js"></script>
</body>
</html>
