<!doctype html> 
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NovaObqva ‚Äî –ü–æ–¥–∞–π –æ–±—è–≤–∞</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="styles/base.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="env.js"></script>
  <style>
    .scrollbar-thin::-webkit-scrollbar{height:8px}
    .scrollbar-thin::-webkit-scrollbar-track{background:#e5e7eb;border-radius:999px}
    .scrollbar-thin::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:999px}
    .planWrap{position:relative}
    .planWrap::before{content:"";position:absolute;inset:-1.5px;border-radius:18px;background:linear-gradient(135deg,#6366f1,#a855f7,#10b981);opacity:0;transition:opacity .25s ease}
    .planWrap.is-selected::before,.planWrap:hover::before{opacity:1}
  </style>
</head>
<body class="bg-slate-50 min-h-screen">

  <!-- HEADER (–º–æ–±–∏–ª–Ω–æ—Ç–æ –≥–æ—Ä–Ω–æ –º–µ–Ω—é –µ –ø—Ä–µ–º–∞—Ö–Ω–∞—Ç–æ) -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <a href="/" class="flex items-center gap-2">
        <img src="favicon.png" alt="" class="w-6 h-6 rounded" />
        <span class="text-xl font-bold">NovaObqva</span>
      </a>

      <nav class="hidden md:flex items-center gap-2 ml-4">
        <a href="index.html" class="px-3 py-1.5 rounded-lg hover:bg-slate-100">–û–±—è–≤–∏</a>
        <a href="plans.html" class="px-3 py-1.5 rounded-lg hover:bg-slate-100">–ü–ª–∞–Ω–æ–≤–µ</a>
      </nav>

      <div class="flex-1"></div>
      <div id="nav-auth-desktop" class="hidden md:flex items-center gap-2"></div>

      <!-- –ü—Ä–µ–º–∞—Ö–Ω–∞—Ç–æ: –±—É—Ç–æ–Ω–∞ –∑–∞ –º–æ–±–∏–ª–Ω–æ –º–µ–Ω—é (#nav-open) -->
    </div>
    <!-- –ü—Ä–µ–º–∞—Ö–Ω–∞—Ç–æ: —Ü–µ–ª–∏—è—Ç Mobile drawer (#drawer) -->
  </header>

  <!-- MAIN -->
  <main class="max-w-6xl mx-auto p-4 md:p-6 pb-24 md:pb-6">
    <div class="bg-white rounded-2xl border shadow-sm p-4 md:p-6">
      <h1 class="text-xl md:text-2xl font-semibold mb-1">–ü–æ–¥–∞–π –Ω–æ–≤–∞ –æ–±—è–≤–∞</h1>
      <p class="text-slate-600 mb-6">–ü–æ–ø—ä–ª–Ω–∏ –ø–æ–ª–µ—Ç–∞—Ç–∞, –¥–æ–±–∞–≤–∏ —Å–Ω–∏–º–∫–∏, –∏–∑–±–µ—Ä–∏ –ø–ª–∞–Ω –∏ –≤–∞–ª—É—Ç–∞, –∏ –∏–∑–ø—Ä–∞—Ç–∏ –∑–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ.</p>

      <form id="adForm" class="space-y-5">
        <div class="grid gap-4 md:grid-cols-2">
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1" for="title">–ó–∞–≥–ª–∞–≤–∏–µ</label>
            <input id="title" required class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-emerald-500" placeholder="–ü—Ä–∏–º–µ—Ä: –î–≤—É—Å—Ç–∞–µ–Ω –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –¥–æ –º–µ—Ç—Ä–æ">
          </div>

          <div>
            <label class="block text-sm font-medium mb-1" for="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            <select id="category" required class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-emerald-500">
              <option value="" disabled selected>‚Äî –∏–∑–±–µ—Ä–µ—Ç–µ ‚Äî</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1" for="city">–ì—Ä–∞–¥ / –ù–∞—Å–µ–ª–µ–Ω–æ –º—è—Å—Ç–æ</label>
            <input id="city" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-emerald-500" placeholder="–°–æ—Ñ–∏—è">
          </div>

          <div>
            <label class="block text-sm font-medium mb-1" for="price">–¶–µ–Ω–∞ (—á–∏—Å–ª–æ)</label>
            <input id="price" type="number" step="0.01" min="0" required class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-emerald-500" placeholder="0.00">
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1" for="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea id="description" rows="5" required class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-emerald-500" placeholder="–û–ø–∏—à–µ—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ‚Ä¶"></textarea>
            <p class="text-xs text-slate-500 mt-1">–°—ä–≤–µ—Ç: –≤–∫–ª—é—á–µ—Ç–µ –∫–ª—é—á–æ–≤–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏, —Å—ä—Å—Ç–æ—è–Ω–∏–µ, –ª–æ–∫–∞—Ü–∏—è –∏ —É—Å–ª–æ–≤–∏—è.</p>
          </div>
        </div>

        <!-- –ö–æ–Ω—Ç–∞–∫—Ç –∑–∞ –æ–±—è–≤–∞—Ç–∞ -->
        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1" for="contact_name">–ò–º–µ –∑–∞ –∫–æ–Ω—Ç–∞–∫—Ç</label>
            <input id="contact_name" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-emerald-500" placeholder="–ò–º–µ –∏ —Ñ–∞–º–∏–ª–∏—è">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" for="contact_phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input id="contact_phone" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-emerald-500" placeholder="+359 ...">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" for="contact_email">–ò–º–µ–π–ª</label>
            <input id="contact_email" type="email" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-emerald-500" placeholder="you@example.com">
          </div>
        </div>

        <!-- –°–Ω–∏–º–∫–∏ —Å ‚Äû–û—Å–Ω–æ–≤–Ω–∞‚Äú -->
        <div>
          <div class="flex items-center justify-between mb-1">
            <label class="block text-sm font-medium">–°–Ω–∏–º–∫–∏</label>
            <span id="imgCount" class="text-xs text-slate-500">0 / 6</span>
          </div>
          <div id="dropzone" class="border-2 border-dashed rounded-xl p-5 md:p-6 text-center text-slate-600 hover:bg-slate-50 cursor-pointer">
            –ü–ª—ä–∑–Ω–µ—Ç–µ —Å–Ω–∏–º–∫–∏ —Ç—É–∫ –∏–ª–∏ –∫–ª–∏–∫–Ω–µ—Ç–µ –∑–∞ –∏–∑–±–æ—Ä
            <input id="images" type="file" accept="image/*" multiple class="sr-only">
          </div>
          <div id="previews" class="mt-3 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"></div>
          <p class="text-xs text-slate-500 mt-2">–î–æ 6 —Ñ–∞–π–ª–∞, –º–∞–∫—Å–∏–º—É–º 10MB –≤—Å—è–∫–∞. –ú–∞—Ä–∫–∏—Ä–∞–π—Ç–µ ‚Äû–û—Å–Ω–æ–≤–Ω–∞‚Äú –∑–∞ –ø—ä—Ä–≤–∞ —Å–Ω–∏–º–∫–∞.</p>
        </div>

        <!-- –ü–ª–∞–Ω–æ–≤–µ (grid) + –≤–∞–ª—É—Ç–∞ -->
        <div>
          <div class="flex flex-col lg:flex-row lg:items-end gap-4">
            <div class="flex-1">
              <label class="block text-sm font-medium mb-2">–ò–∑–±–µ—Ä–µ—Ç–µ –ø–ª–∞–Ω</label>
              <div id="plansBar" class="grid gap-5 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3"></div>
            </div>
            <div class="w-full lg:w-44">
              <label class="block text-sm font-medium mb-1">–í–∞–ª—É—Ç–∞</label>
              <div id="currencySwitch" class="flex w-full lg:inline-flex rounded-xl border bg-white shadow-sm overflow-hidden">
                <button type="button" data-cur="bgn" class="curBtn flex-1 px-3 py-2 text-sm font-medium aria-selected:bg-emerald-600 aria-selected:text-white">üáßüá¨ BGN</button>
                <button type="button" data-cur="eur" class="curBtn flex-1 px-3 py-2 text-sm font-medium text-slate-600">üá™üá∫ EUR</button>
              </div>
            </div>
          </div>
          <p class="text-xs text-slate-500 mt-2">–ü–ª–∞–Ω—ä—Ç –æ–ø—Ä–µ–¥–µ–ª—è –≤–∏–¥–∏–º–æ—Å—Ç –∏ –¥–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∏ –æ–ø—Ü–∏–∏. –ü–ª–∞—â–∞–Ω–µ—Ç–æ —Å–µ –ø—Ä–∞–≤–∏ —Å–ª–µ–¥ –∏–∑–ø—Ä–∞—â–∞–Ω–µ.</p>
        </div>

        <button type="submit" class="hidden md:block w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-lg font-medium">–ò–∑–ø—Ä–∞—Ç–∏ –∑–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ</button>
        <p id="msg" class="text-center text-sm" aria-live="polite"></p>
      </form>

      <!-- –†–µ–∑—É–ª—Ç–∞—Ç -->
      <div id="result" class="mt-6 hidden">
        <div class="p-4 rounded-xl border bg-emerald-50 text-emerald-800">
          <div class="font-semibold">–£—Å–ø–µ—à–Ω–æ –∏–∑–ø—Ä–∞—Ç–µ–Ω–∞!</div>
          <p class="text-sm">–û–±—è–≤–∞—Ç–∞ –µ –∑–∞–ø–∏—Å–∞–Ω–∞ –∏ —á–∞–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä.</p>
        </div>
        <div class="mt-4 grid gap-3 md:grid-cols-2">
          <a id="payBtn" target="_blank" rel="noopener" class="text-center px-4 py-3 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">–ü—Ä–µ–º–∏–Ω–∏ –∫—ä–º –ø–ª–∞—â–∞–Ω–µ</a>
          <a id="viewBtn" class="text-center px-4 py-3 rounded-lg border hover:bg-slate-50">–ü—Ä–µ–≥–ª–µ–¥ –Ω–∞ –æ–±—è–≤–∞—Ç–∞</a>
        </div>
      </div>
    </div>
  </main>

  <!-- Sticky submit –∑–∞ –º–æ–±–∏–ª–Ω–∏ -->
  <div id="stickyBar" class="md:hidden fixed bottom-0 inset-x-0 bg-white/95 backdrop-blur border-t p-3">
    <div class="max-w-6xl mx-auto px-2">
      <button id="stickySubmit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-lg font-medium">–ò–∑–ø—Ä–∞—Ç–∏ –∑–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ</button>
    </div>
  </div>

  <script>
    const sb = supabase.createClient(window.ENV.SUPABASE_URL, window.ENV.SUPABASE_ANON_KEY);

    async function ensureAuth() {
      const { data:{ user } } = await sb.auth.getUser();
      if (!user) {
        location.replace('auth.html?redirectTo=' + encodeURIComponent(location.href));
        return new Promise(()=>{});
      }
      return user;
    }

    // –•–µ–¥—ä—Ä auth
    (async function renderAuthAreas() {
      const { data: { user } } = await sb.auth.getUser();
      const d = document.getElementById('nav-auth-desktop');
      const m = document.getElementById('nav-auth-mobile'); // –Ω—è–º–∞ –º–æ–±–∏–ª–µ–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä; –±–µ–∑–æ–ø–∞—Å–Ω–æ
      const loginHref = `auth.html?redirectTo=${encodeURIComponent(location.href)}`;
      let desktopHTML = '', mobileHTML  = '';
      if (user) {
        desktopHTML = `<a href="chat.html" class="px-3 py-1.5 rounded-lg hover:bg-slate-100">–°—ä–æ–±—â–µ–Ω–∏—è</a>
                       <a href="account.html" class="px-3 py-1.5 rounded-lg border bg-white hover:bg-slate-50 text-sm">–ú–æ—è—Ç –ø—Ä–æ—Ñ–∏–ª</a>
                       <button id=\"nav-logout\" class=\"px-3 py-1.5 rounded-lg bg-slate-800 text-white text-sm\">–ò–∑—Ö–æ–¥</button>`;
      } else {
        desktopHTML = `<a href="${loginHref}" class="px-3 py-1.5 rounded-lg bg-emerald-600 text-white text-sm">–í—Ö–æ–¥</a>`;
      }
      if (d) { d.classList.remove('hidden'); d.innerHTML = desktopHTML; }
      if (m) { m.innerHTML = mobileHTML; }
      [document.getElementById('nav-logout'), document.getElementById('nav-logout-m')].filter(Boolean).forEach(btn => {
        btn.addEventListener('click', async () => { await sb.auth.signOut(); location.reload(); });
      });
    })();

    // Drawer (guard: –Ω—è–º–∞ –µ–ª–µ–º–µ–Ω—Ç–∏, –Ω–æ –æ—Å—Ç–∞–≤—è–º–µ –±–µ–∑–≤—Ä–µ–¥–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞)
    (function initDrawer(){
      const drawer = document.getElementById('drawer'); if (!drawer) return;
      const openBtn  = document.getElementById('nav-open');
      const closeBtn = document.getElementById('nav-close');
      const backdrop = document.getElementById('backdrop');
      const open  = () => { drawer.classList.remove('hidden'); document.body.classList.add('overflow-hidden'); };
      const close = () => { drawer.classList.add('hidden');    document.body.classList.remove('overflow-hidden'); };
      openBtn?.addEventListener('click', open);
      closeBtn?.addEventListener('click', close);
      backdrop?.addEventListener('click', close);
      window.addEventListener('keydown', (e)=>{ if (e.key==='Escape') close(); });
    })();

    // ===== –§–û–†–ú–ê =====
    const CATEGORIES = ['–ù–µ–¥–≤–∏–∂–∏–º–∏ –∏–º–æ—Ç–∏','–ê–≤—Ç–æ–º–æ–±–∏–ª–∏','–†–∞–±–æ—Ç–∞','–£—Å–ª—É–≥–∏','–¢–µ—Ö–Ω–∏–∫–∞','–î–æ–º –∏ –≥—Ä–∞–¥–∏–Ω–∞','–ñ–∏–≤–æ—Ç–Ω–∏','–ú–æ–¥–∞','–°–ø–æ—Ä—Ç','–ò–≥—Ä–∏ –∏ —Ö–æ–±–∏','–î—Ä—É–≥–∏'];
    const FALLBACK_PLANS = [
      { id:'starter', name:'Starter', price_bgn:9.99,  price_eur:5.10,
        pay_url:{ bgn:'https://checkout.revolut.com/payment-link/b9d03509-71b2-4c35-8d3a-43357e663650',
                  eur:'https://checkout.revolut.com/payment-link/f776550f-0424-4656-aacb-3c1f06c6014b' },
        features:['–ü—É–±–ª–∏–∫—É–≤–∞–Ω–µ 30 –¥–Ω–∏','–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –≤–∏–¥–∏–º–æ—Å—Ç'] },
      { id:'pro', name:'Pro',       price_bgn:19.99, price_eur:10.22,
        pay_url:{ bgn:'https://checkout.revolut.com/payment-link/b0cc7f69-9a29-4559-8eed-a06ffc1b2604',
                  eur:'https://checkout.revolut.com/payment-link/62ddc3ea-6192-4b5d-875b-a90d80235edf' },
        features:['–ü—É–±–ª–∏–∫—É–≤–∞–Ω–µ 60 –¥–Ω–∏','–ü–æ–≤–∏—à–µ–Ω–∞ –≤–∏–¥–∏–º–æ—Å—Ç','–¢–æ–ø'] },
      { id:'max', name:'Max',       price_bgn:39.99, price_eur:20.45,
        pay_url:{ bgn:'https://checkout.revolut.com/payment-link/e336d64c-7c6a-4962-a7ba-0f9a0e8f3a10',
                  eur:'https://checkout.revolut.com/payment-link/cc4190df-60c1-4f8c-9d3a-c0a949dbb527' },
        features:['–ü—É–±–ª–∏–∫—É–≤–∞–Ω–µ 90 –¥–Ω–∏','–ú–∞–∫—Å. –≤–∏–¥–∏–º–æ—Å—Ç','–ó–∞–∫—Ä–µ–ø–≤–∞–Ω–µ'] }
    ];

    const el = (id)=>document.getElementById(id);
    const msg = (t,err=false)=>{ const m=el('msg'); m.textContent=t; m.className='text-center text-sm '+(err?'text-rose-600':'text-slate-600'); };

    let currentUser=null, plans=[], selectedPlan=null, selectedFiles=[], currentCurrency='bgn', selectedCoverIndex=0;

    (async ()=>{
      currentUser = await ensureAuth();

      // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
      const catSel=el('category'); CATEGORIES.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; catSel.appendChild(o); });

      // –ö–æ–Ω—Ç–∞–∫—Ç ‚Äî –ø–æ–ø—ä–ª–Ω–∏ –∏–º–µ–π–ª–∞ –ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ
      el('contact_email').value = currentUser?.email || '';

      // –ü–ª–∞–Ω–æ–≤–µ
      try{
        const { data, error } = await sb.from('plans').select('id,name,price_bgn,price_eur,pay_url,features,is_active,position').order('position');
        if (!error && data?.length){
          plans=data.map(p=>{
            let pay=p.pay_url;
            if (typeof pay==='string' && pay.trim().startsWith('{')){ try{ pay=JSON.parse(pay); }catch{ pay={bgn:pay,eur:pay}; } }
            if (typeof pay!=='object') pay={bgn:pay,eur:pay};
            return { id:p.id, name:p.name, price_bgn:Number(p.price_bgn), price_eur:Number(p.price_eur), pay_url:pay, features:p.features||[] };
          });
        }
      }catch(_){}}
      if (!plans.length) plans=FALLBACK_PLANS;
      renderPlans();

      // –°–Ω–∏–º–∫–∏
      const drop=el('dropzone'), input=el('images');
      drop.addEventListener('click', ()=>input.click());
      drop.addEventListener('dragover', e=>{e.preventDefault(); drop.classList.add('bg-slate-50');});
      drop.addEventListener('dragleave', ()=>drop.classList.remove('bg-slate-50'));
      drop.addEventListener('drop', e=>{e.preventDefault(); drop.classList.remove('bg-slate-50'); addFiles([...e.dataTransfer.files]);});
      input.addEventListener('change', e=>addFiles([...e.target.files]));

      // Submit
      el('adForm').addEventListener('submit', onSubmit);
      el('stickySubmit').addEventListener('click', ()=>el('adForm').requestSubmit());

      // –í–∞–ª—É—Ç–µ–Ω –ø—Ä–µ–≤–∫–ª—é—á–≤–∞—Ç–µ–ª
      document.querySelectorAll('#currencySwitch .curBtn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          currentCurrency=btn.dataset.cur;
          document.querySelectorAll('#currencySwitch .curBtn').forEach(b=>{
            const on=b===btn; b.setAttribute('aria-selected', on?'true':'false');
            b.classList.toggle('text-slate-600',!on); b.classList.toggle('text-white',on); b.classList.toggle('bg-emerald-600',on);
          });
          renderPlans();
        });
      });
      document.querySelector('#currencySwitch [data-cur="bgn"]').click();
    })();

    function renderPlans(){
      const bar=el('plansBar'); bar.innerHTML='';
      const cur=currentCurrency;
      plans.forEach(p=>{
        const price=cur==='eur'?Number(p.price_eur):Number(p.price_bgn);
        const wrap=document.createElement('div'); wrap.className='planWrap';
        const isPro=(p.name||'').toLowerCase()==='pro';
        const badge=isPro?`<span class="absolute -top-3 left-4 z-10 text-[11px] px-2 py-1 rounded-full bg-indigo-600 text-white shadow">–ù–∞–π-–ø–æ–ø—É–ª—è—Ä–µ–Ω</span>`:'';
        wrap.innerHTML=`
          ${badge}
          <button type="button" class="relative group w-full rounded-2xl border bg-white/70 backdrop-blur-md hover:shadow-lg transition-all duration-300 p-5 text-left">
            <div class="flex items-center justify-between">
              <div class="text-lg md:text-xl font-semibold">${escapeHTML(p.name)}</div>
              <div class="text-base md:text-lg font-bold">
                <span class="bg-gradient-to-r from-emerald-600 to-indigo-600 bg-clip-text text-transparent">${isFinite(price)?price.toFixed(2):'‚Äî'} ${cur.toUpperCase()}</span>
              </div>
            </div>
            <ul class="mt-3 text-sm text-slate-600 space-y-1">${
              (p.features||[]).map(f=>`<li class="flex items-center gap-2">
                 <svg width="16" height="16" viewBox="0 0 24 24" class="shrink-0 text-emerald-600"><path fill="currentColor" d="M9 16.2 4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"/></svg>${escapeHTML(String(f))}
              </li>`).join('') || '<li class="text-slate-400">–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏ –µ–∫—Å—Ç—Ä–∏</li>'
            }</ul>
            <div class="mt-4"><span class="inline-flex items-center gap-1 text-xs px-3 py-1 rounded-lg bg-slate-100 text-slate-700 group-hover:bg-slate-200 transition">–∏–∑–±–µ—Ä–∏</span></div>
          </button>`;
        wrap.querySelector('button').addEventListener('click', ()=>{
          selectedPlan=p;
          [...bar.children].forEach(c=>c.classList.remove('is-selected'));
          wrap.classList.add('is-selected');
        });
        bar.appendChild(wrap);
      });
      if (!selectedPlan && bar.children.length){ bar.children[0].classList.add('is-selected'); selectedPlan=plans[0]; }
    }

    function addFiles(files){
      const MAX=6; const filtered=[];
      for (const f of files){
        if (!f.type.startsWith('image/')) continue;
        if (f.size>10*1024*1024){ msg(`–§–∞–π–ª—ä—Ç ${f.name} –µ –Ω–∞–¥ 10MB –∏ –±–µ—à–µ –ø—Ä–æ–ø—É—Å–Ω–∞—Ç.`, true); continue; }
        filtered.push(f);
      }
      const remain=Math.max(0, MAX-selectedFiles.length);
      if (remain<=0){ msg('–î–æ—Å—Ç–∏–≥–Ω–∞—Ç –µ –ª–∏–º–∏—Ç—ä—Ç –æ—Ç 6 —Å–Ω–∏–º–∫–∏.', true); return; }
      selectedFiles=selectedFiles.concat(filtered.slice(0, remain));
      if (selectedFiles.length && (selectedCoverIndex==null || selectedCoverIndex>=selectedFiles.length)) selectedCoverIndex=0;
      renderPreviews();
    }

    function renderPreviews(){
      const box=el('previews'); box.innerHTML='';
      el('imgCount').textContent=`${selectedFiles.length} / 6`;
      selectedFiles.forEach((file, idx)=>{
        const url=URL.createObjectURL(file);
        const isCover=idx===selectedCoverIndex;
        const wrap=document.createElement('div'); wrap.className='relative group';
        wrap.innerHTML=`
          <button type="button" data-cover="${idx}" class="absolute top-1 left-1 z-10 rounded-full border bg-white/90 px-2 py-1 text-[11px] ${isCover?'border-indigo-500 text-indigo-600':'text-slate-700'}">${isCover?'–û—Å–Ω–æ–≤–Ω–∞':'–ù–∞–ø—Ä–∞–≤–∏ –æ—Å–Ω.'}</button>
          <img src="${url}" class="w-full h-28 object-cover rounded-lg border ${isCover?'ring-2 ring-indigo-500':''}" alt="–°–Ω–∏–º–∫–∞ ${idx+1}">
          <button type="button" class="absolute top-1 right-1 bg-white/90 border rounded-md px-2 py-1 text-xs">–ü—Ä–µ–º–∞—Ö–Ω–∏</button>`;
        wrap.querySelector('.absolute.top-1.right-1').addEventListener('click', ()=>{
          selectedFiles.splice(idx,1);
          if (selectedFiles.length===0) selectedCoverIndex=0;
          else if (idx<selectedCoverIndex) selectedCoverIndex-=1;
          else if (idx===selectedCoverIndex) selectedCoverIndex=0;
          renderPreviews();
        });
        wrap.querySelector(`[data-cover="${idx}"]`).addEventListener('click', ()=>{ selectedCoverIndex=idx; renderPreviews(); });
        wrap.querySelector('img').addEventListener('click', ()=>{ selectedCoverIndex=idx; renderPreviews(); });
        box.appendChild(wrap);
      });
    }

    async function onSubmit(e){
      e.preventDefault(); msg('');
      const title=el('title').value.trim();
      const description=el('description').value.trim();
      const category=el('category').value;
      const city=el('city').value.trim();
      const price=parseFloat(el('price').value);
      const currency=currentCurrency;

      const contact_name = el('contact_name').value.trim();
      const contact_phone= el('contact_phone').value.trim();
      const contact_email= el('contact_email').value.trim() || (await sb.auth.getUser()).data.user.email;

      if (!title || !description || !category || isNaN(price)) { msg('–ü–æ–ø—ä–ª–Ω–µ—Ç–µ –≤—Å–∏—á–∫–∏ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∏ –ø–æ–ª–µ—Ç–∞.', true); return; }
      if (!selectedPlan) { msg('–ú–æ–ª—è, –∏–∑–±–µ—Ä–µ—Ç–µ –ø–ª–∞–Ω.', true); return; }

      let image_urls=[];
      if (selectedFiles.length){
        const uploaded=await uploadImages(selectedFiles);
        if (uploaded.error){
          if (uploaded.error.includes('Bucket not found')) { msg('–í–Ω–∏–º–∞–Ω–∏–µ: –ª–∏–ø—Å–≤–∞ bucket ad-images ‚Äî –ø—Ä–æ–¥—ä–ª–∂–∞–≤–∞–º –±–µ–∑ —Å–Ω–∏–º–∫–∏.', false); }
          else { msg(uploaded.error, true); return; }
        } else {
          image_urls=uploaded.urls;
        }
      }

      const cover_index=Math.min(Math.max(selectedCoverIndex||0,0), Math.max(image_urls.length-1,0));
      const cover_image=image_urls[cover_index] || null;

      const plan_price = currency==='eur'?Number(selectedPlan.price_eur):Number(selectedPlan.price_bgn);
      const insertPayload = {
        user_id: (await sb.auth.getUser()).data.user.id,
        title, description, price, city, category,
        images: image_urls, cover_image, cover_index,
        plan_id: selectedPlan.id, plan_name: selectedPlan.name,
        plan_price: plan_price, plan_currency: currency.toUpperCase(),
        contact_name, contact_phone, contact_email,
        ad_status: 'pending'
      };

      const { data, error } = await sb.from('ads').insert([insertPayload]).select('id').single();
      if (error){ console.error(error); msg('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å. –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –ø—Ä–∞–≤–∞—Ç–∞ (RLS) –∏ –ø–æ–ª–µ—Ç–∞—Ç–∞ –≤ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞.', true); return; }

      el('adForm').classList.add('hidden'); el('stickyBar').classList.add('hidden');
      el('result').classList.remove('hidden');
      el('viewBtn').href='ad.html?id='+encodeURIComponent(data.id);

      const payBtn=el('payBtn'), payUrl=selectedPlan?.pay_url?.[currency];
      if (payUrl){ payBtn.href=payUrl; payBtn.textContent='–ü—Ä–µ–º–∏–Ω–∏ –∫—ä–º –ø–ª–∞—â–∞–Ω–µ ('+currency.toUpperCase()+')'; }
      else { payBtn.href='#'; payBtn.classList.add('pointer-events-none','opacity-60'); payBtn.textContent='–ù—è–º–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø–ª–∞—Ç–µ–∂–µ–Ω –ª–∏–Ω–∫'; }

      msg(''); window.scrollTo({top:0,behavior:'smooth'});
    }

    async function uploadImages(files){
      try{
        const { data:{ user } } = await sb.auth.getUser();
        const urls=[];
        for (const f of files){
          const ext=(f.name.split('.').pop()||'jpg').toLowerCase();
          const path=`${user.id}/${crypto.randomUUID()}.${ext}`;
          const { error: upErr } = await sb.storage.from('ad-images').upload(path, f, { upsert:false, contentType:f.type });
          if (upErr) return { error:'–ö–∞—á–≤–∞–Ω–µ—Ç–æ –ø—Ä–µ–∫—ä—Å–Ω–∞: ' + upErr.message };
          const { data: pub } = sb.storage.from('ad-images').getPublicUrl(path);
          urls.push(pub.publicUrl);
        }
        return { urls };
      }catch(err){ console.error(err); return { error:'–ù–µ—É—Å–ø–µ—à–Ω–æ –∫–∞—á–≤–∞–Ω–µ –Ω–∞ —Å–Ω–∏–º–∫–∏.' }; }
    }

    function escapeHTML(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  </script>

  <!-- –ï–¥–∏–Ω–µ–Ω shell: –º–æ–±–∏–ª–µ–Ω –¥–æ–∫ + —á–∞—Ç –±–µ–π–¥–∂/–Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ -->
  <script src="shell-mobile.js"></script>

  <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –∑–∞ –ë–î:
  alter table public.ads
    add column if not exists cover_image text,
    add column if not exists cover_index int,
    add column if not exists contact_name text,
    add column if not exists contact_phone text,
    add column if not exists contact_email text;
  -->
</body>
</html>
