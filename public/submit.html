<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NovaObqva — Подай обява</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="env.js"></script>
  <style>
    .scrollbar-thin::-webkit-scrollbar{height:8px}
    .scrollbar-thin::-webkit-scrollbar-track{background:#e5e7eb;border-radius:999px}
    .scrollbar-thin::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:999px}
  </style>
</head>
<body class="bg-slate-50 min-h-screen">
  <header class="sticky top-0 bg-white/80 backdrop-blur border-b">
    <div class="max-w-3xl mx-auto p-4 flex items-center gap-3">
      <a href="/" class="text-2xl font-bold">NovaObqva</a>
      <div class="flex-1"></div>
      <a href="auth.html" class="text-sm text-slate-600 hover:text-slate-900">Вход</a>
    </div>
  </header>

  <main class="max-w-3xl mx-auto p-6">
    <div class="bg-white rounded-2xl border shadow-sm p-6">
      <h1 class="text-xl font-semibold mb-1">Подай нова обява</h1>
      <p class="text-slate-600 mb-6">Попълни полетата, добави снимки, избери план и валута, и изпрати за одобрение.</p>

      <!-- ФОРМА -->
      <form id="adForm" class="space-y-5">
        <div>
          <label class="block text-sm font-medium mb-1">Заглавие</label>
          <input type="text" id="title" required class="w-full border rounded-lg px-3 py-2" placeholder="Пример: Двустаен апартамент до метро">
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Категория</label>
          <select id="category" required class="w-full border rounded-lg px-3 py-2">
            <option value="" disabled selected>— изберете —</option>
          </select>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Град / Населено място</label>
            <input type="text" id="city" class="w-full border rounded-lg px-3 py-2" placeholder="София">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Цена (число)</label>
            <input type="number" id="price" step="0.01" min="0" required class="w-full border rounded-lg px-3 py-2" placeholder="0.00">
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Описание</label>
          <textarea id="description" required class="w-full border rounded-lg px-3 py-2" rows="5" placeholder="Опишете подробно…"></textarea>
          <p class="text-xs text-slate-500 mt-1">Съвет: включете ключови характеристики, състояние, локация и условия.</p>
        </div>

        <!-- СНИМКИ -->
        <div>
          <label class="block text-sm font-medium mb-1">Снимки (до 6 файла, макс. 10MB всяка)</label>
          <div id="dropzone" class="border-2 border-dashed rounded-xl p-6 text-center text-slate-600 hover:bg-slate-50 cursor-pointer">
            Плъзнете снимки тук или кликнете за избор
            <input id="images" type="file" accept="image/*" multiple class="hidden">
          </div>
          <div id="previews" class="mt-3 grid grid-cols-3 gap-3"></div>
          <p class="text-xs text-slate-500 mt-2">Първата снимка е основна. Можете да премахвате и добавяте за смяна на реда.</p>
        </div>

        <!-- ПЛАНОВЕ + ВАЛУТА -->
        <div>
          <div class="flex items-end gap-3">
            <div class="flex-1">
              <label class="block text-sm font-medium mb-2">Изберете план</label>
              <div id="plansBar" class="flex gap-4 overflow-x-auto pb-2 scrollbar-thin"></div>
            </div>
            <div class="w-40">
              <label class="block text-sm font-medium mb-1">Валута</label>
              <select id="currency" class="border rounded-lg px-3 py-2 w-full">
                <option value="bgn">Лева (BGN)</option>
                <option value="eur">Евро (EUR)</option>
              </select>
            </div>
          </div>
          <p class="text-xs text-slate-500 mt-2">Планът определя видимост и допълнителни опции. Плащането става след изпращане.</p>
        </div>

        <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-lg font-medium">
          Изпрати за одобрение
        </button>
      </form>

      <!-- РЕЗУЛТАТ -->
      <div id="result" class="mt-6 hidden">
        <div class="p-4 rounded-xl border bg-emerald-50 text-emerald-800">
          <div class="font-semibold">Успешно изпратена!</div>
          <p class="text-sm">Обявата е записана и чака одобрение от администратор.</p>
        </div>
        <div class="mt-4 flex flex-col md:flex-row gap-3">
          <a id="payBtn" target="_blank" rel="noopener" class="md:flex-1 text-center px-4 py-3 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Премини към плащане</a>
          <a id="viewBtn" class="md:flex-1 text-center px-4 py-3 rounded-lg border hover:bg-slate-50">Преглед на обявата</a>
        </div>
      </div>

      <p id="msg" class="mt-4 text-center text-sm"></p>
    </div>
  </main>

  <script>
    const sb = supabase.createClient(window.ENV.SUPABASE_URL, window.ENV.SUPABASE_ANON_KEY);

    const CATEGORIES = [
      'Недвижими имоти','Автомобили','Работа','Услуги','Техника',
      'Дом и градина','Животни','Мода','Спорт','Игри и хоби','Други'
    ];

    // ПАДАТ-БЕК планове с BGN/EUR линкове (по твоя списък)
    const FALLBACK_PLANS = [
      {
        id: 'starter',
        name: 'Starter',
        price_bgn: 9.99,
        price_eur: 5.10,
        pay_url: {
          bgn: 'https://checkout.revolut.com/payment-link/b9d03509-71b2-4c35-8d3a-43357e663650',
          eur: 'https://checkout.revolut.com/payment-link/f776550f-0424-4656-aacb-3c1f06c6014b'
        },
        features: ['Публикуване 30 дни','Стандартна видимост']
      },
      {
        id: 'pro',
        name: 'Pro',
        price_bgn: 19.99,
        price_eur: 10.22,
        pay_url: {
          bgn: 'https://checkout.revolut.com/payment-link/b0cc7f69-9a29-4559-8eed-a06ffc1b2604',
          eur: 'https://checkout.revolut.com/payment-link/62ddc3ea-6192-4b5d-875b-a90d80235edf'
        },
        features: ['Публикуване 60 дни','Повишена видимост','Топ']
      },
      {
        id: 'max',
        name: 'Max',
        price_bgn: 39.99,
        price_eur: 20.45,
        pay_url: {
          bgn: 'https://checkout.revolut.com/payment-link/e336d64c-7c6a-4962-a7ba-0f9a0e8f3a10',
          eur: 'https://checkout.revolut.com/payment-link/cc4190df-60c1-4f8c-9d3a-c0a949dbb527'
        },
        features: ['Публикуване 90 дни','Макс. видимост','Закрепване']
      }
    ];

    const el = (id) => document.getElementById(id);
    const msg = (text, err=false) => { const m = el('msg'); m.textContent = text; m.className = 'mt-4 text-center text-sm ' + (err?'text-rose-600':'text-slate-600'); };

    let currentUser = null;
    let plans = [];           // от БД или fallback
    let selectedPlan = null;  // текущо избрания план
    let selectedFiles = [];   // File[]

    (async () => {
      // 1) require login
      const { data: { user } } = await sb.auth.getUser();
      if (!user) { location.href = 'auth.html?redirectTo=' + encodeURIComponent(location.href); return; }
      currentUser = user;

      // 2) fill categories
      const catSel = el('category');
      CATEGORIES.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c; opt.textContent = c; catSel.appendChild(opt);
      });

      // 3) load plans table (ако имаш), иначе fallback
      try {
        const { data, error } = await sb.from('plans').select('id,name,price,pay_url,features,price_bgn,price_eur');
        if (!error && data?.length) {
          plans = data.map(p => ({
            id: p.id, name: p.name,
            price_bgn: Number(p.price_bgn ?? p.price), // съвместимост
            price_eur: Number(p.price_eur ?? p.price),
            pay_url: typeof p.pay_url === 'object' ? p.pay_url : { bgn: p.pay_url, eur: p.pay_url },
            features: p.features || []
          }));
        }
      } catch(_) {}
      if (!plans.length) plans = FALLBACK_PLANS;

      renderPlans();

      // 4) images handling
      const drop = el('dropzone'); const input = el('images');
      drop.addEventListener('click', ()=> input.click());
      drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('bg-slate-50'); });
      drop.addEventListener('dragleave', ()=> drop.classList.remove('bg-slate-50'));
      drop.addEventListener('drop', e => { e.preventDefault(); drop.classList.remove('bg-slate-50'); addFiles([...e.dataTransfer.files]); });
      input.addEventListener('change', e => addFiles([...e.target.files]));

      // 5) submit
      el('adForm').addEventListener('submit', onSubmit);

      // 6) currency change → rerender prices
      el('currency').addEventListener('change', renderPlans);
    })();

    function renderPlans(){
      const bar = el('plansBar'); bar.innerHTML = '';
      const currency = el('currency').value; // 'bgn' | 'eur'
      plans.forEach(p => {
        const price = currency === 'eur' ? Number(p.price_eur) : Number(p.price_bgn);
        const card = document.createElement('button');
        card.type = 'button';
        card.className = 'min-w-[240px] text-left border rounded-2xl p-4 bg-white hover:border-slate-400';
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="text-lg font-semibold">${escapeHTML(p.name)}</div>
            <div class="text-emerald-700 font-bold">${isFinite(price) ? price.toFixed(2) : '—'} ${currency.toUpperCase()}</div>
          </div>
          <ul class="mt-2 text-sm text-slate-600 space-y-1">${
            (p.features||[]).map(f=>`<li>• ${escapeHTML(String(f))}</li>`).join('') || '<li class="text-slate-400">Без описани екстри</li>'
          }</ul>
          <div class="mt-3">
            <span class="inline-block text-xs px-2 py-1 rounded bg-slate-100 text-slate-700">избери</span>
          </div>
        `;
        card.addEventListener('click', ()=>{
          selectedPlan = p;
          [...bar.children].forEach(c=>c.classList.remove('ring-2','ring-indigo-500'));
          card.classList.add('ring-2','ring-indigo-500');
        });
        bar.appendChild(card);
      });
      if (bar.children.length) bar.children[0].click();
    }

    function addFiles(files){
      const MAX = 6;
      const filtered = [];
      for (const file of files) {
        if (!file.type.startsWith('image/')) continue;
        if (file.size > 10*1024*1024) { msg(`Файлът ${file.name} е над 10MB и беше пропуснат.`, true); continue; }
        filtered.push(file);
      }
      const remain = Math.max(0, MAX - selectedFiles.length);
      selectedFiles = selectedFiles.concat(filtered.slice(0, remain));
      renderPreviews();
    }

    function renderPreviews(){
      const box = el('previews'); box.innerHTML = '';
      selectedFiles.forEach((file, idx) => {
        const url = URL.createObjectURL(file);
        const wrap = document.createElement('div');
        wrap.className = 'relative group';
        wrap.innerHTML = `
          <img src="${url}" class="w-full h-28 object-cover rounded-lg border">
          <button type="button" class="absolute top-1 right-1 bg-white/90 border rounded-md px-2 py-1 text-xs hidden group-hover:block">Премахни</button>
        `;
        wrap.querySelector('button').addEventListener('click', ()=>{
          selectedFiles.splice(idx,1);
          renderPreviews();
        });
        box.appendChild(wrap);
      });
    }

    async function onSubmit(e){
      e.preventDefault(); msg('');
      const title = el('title').value.trim();
      const description = el('description').value.trim();
      const category = el('category').value;
      const city = el('city').value.trim();
      const price = parseFloat(el('price').value);
      const currency = el('currency').value; // bgn|eur

      if (!title || !description || !category || isNaN(price)) { msg('Попълнете всички задължителни полета.', true); return; }
      if (!selectedPlan) { msg('Моля, изберете план.', true); return; }

      // 1) качи снимките (ако има)
      let image_urls = [];
      if (selectedFiles.length){
        const uploaded = await uploadImages(selectedFiles);
        if (uploaded.error) { msg(uploaded.error, true); return; }
        image_urls = uploaded.urls;
      }

      // 2) запис в ads (pending)
      const plan_price = currency === 'eur' ? Number(selectedPlan.price_eur) : Number(selectedPlan.price_bgn);
      const insertPayload = {
        user_id: currentUser.id,
        title, description, price, city, category,
        images: image_urls,                     // jsonb
        plan_id: selectedPlan.id,
        plan_name: selectedPlan.name,
        plan_price: plan_price,
        plan_currency: currency.toUpperCase(),  // BGN/EUR
        ad_status: 'pending'
      };

      const { data, error } = await sb.from('ads').insert([insertPayload]).select('id').single();
      if (error) { console.error(error); msg('Грешка при запис. Проверете правата (RLS) и полетата в таблицата.', true); return; }

      // 3) покажи резултат + бутон за плащане според валутата
      el('adForm').classList.add('hidden');
      const res = el('result'); res.classList.remove('hidden');
      el('viewBtn').href = 'ad.html?id=' + encodeURIComponent(data.id);

      const payBtn = el('payBtn');
      const payUrl = selectedPlan?.pay_url?.[currency];
      if (payUrl) {
        payBtn.href = payUrl;
        payBtn.textContent = 'Премини към плащане (' + currency.toUpperCase() + ')';
      } else {
        payBtn.href = '#';
        payBtn.classList.add('pointer-events-none','opacity-60');
        payBtn.textContent = 'Няма настроен платежен линк';
      }

      msg('');
      window.scrollTo({top:0, behavior:'smooth'});
    }

    async function uploadImages(files){
      try{
        const urls = [];
        for (const f of files){
          const ext = (f.name.split('.').pop() || 'jpg').toLowerCase();
          const path = `${currentUser.id}/${crypto.randomUUID()}.${ext}`;
          const { error: upErr } = await sb.storage.from('ad-images').upload(path, f, { upsert: false, contentType: f.type });
          if (upErr) return { error: 'Качването прекъсна: ' + upErr.message };
          const { data: pub } = sb.storage.from('ad-images').getPublicUrl(path);
          urls.push(pub.publicUrl);
        }
        return { urls };
      }catch(err){
        console.error(err);
        return { error: 'Неуспешно качване на снимки.' };
      }
    }

    function escapeHTML(s){
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');
    }
  </script>
</body>
</html>
