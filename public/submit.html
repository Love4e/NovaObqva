<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NovaObqva ‚Äî –ü–æ–¥–∞–π –æ–±—è–≤–∞</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="env.js"></script>
  <style>
    /* —Ç—ä–Ω—ä–∫ —Ö–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–µ–Ω —Å–∫—Ä–æ–ª */
    .scrollbar-thin::-webkit-scrollbar{height:8px}
    .scrollbar-thin::-webkit-scrollbar-track{background:#e5e7eb;border-radius:999px}
    .scrollbar-thin::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:999px}
    /* –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω–∞ —Ä–∞–º–∫–∞ –∑–∞ –∏–∑–±—Ä–∞–Ω–∞—Ç–∞ –∫–∞—Ä—Ç–∞ */
    .planWrap{ position:relative }
    .planWrap::before{
      content:""; position:absolute; inset:-1.5px; border-radius:18px;
      background:linear-gradient(135deg,#6366f1,#a855f7,#10b981);
      opacity:0; transition:opacity .25s ease;
    }
    .planWrap.is-selected::before,.planWrap:hover::before{ opacity:1 }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">
  <header class="sticky top-0 bg-white/80 backdrop-blur border-b">
    <div class="max-w-4xl mx-auto px-4 py-3 flex items-center gap-3">
      <a href="/" class="text-2xl font-bold">NovaObqva</a>
      <div class="flex-1"></div>
      <a href="auth.html" class="text-sm text-slate-600 hover:text-slate-900">–í—Ö–æ–¥</a>
    </div>
  </header>

  <main class="max-w-4xl mx-auto p-4 md:p-6 pb-24 md:pb-6">
    <div class="bg-white rounded-2xl border shadow-sm p-4 md:p-6">
      <h1 class="text-xl md:text-2xl font-semibold mb-1">–ü–æ–¥–∞–π –Ω–æ–≤–∞ –æ–±—è–≤–∞</h1>
      <p class="text-slate-600 mb-6">–ü–æ–ø—ä–ª–Ω–∏ –ø–æ–ª–µ—Ç–∞—Ç–∞, –¥–æ–±–∞–≤–∏ —Å–Ω–∏–º–∫–∏, –∏–∑–±–µ—Ä–∏ –ø–ª–∞–Ω –∏ –≤–∞–ª—É—Ç–∞, –∏ –∏–∑–ø—Ä–∞—Ç–∏ –∑–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ.</p>

      <!-- –§–û–†–ú–ê -->
      <form id="adForm" class="space-y-5">
        <div class="grid gap-4 md:grid-cols-2">
          <div class="md:col-span-2">
            <label for="title" class="block text-sm font-medium mb-1">–ó–∞–≥–ª–∞–≤–∏–µ</label>
            <input id="title" type="text" required
                   class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                   placeholder="–ü—Ä–∏–º–µ—Ä: –î–≤—É—Å—Ç–∞–µ–Ω –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –¥–æ –º–µ—Ç—Ä–æ">
          </div>

          <div>
            <label for="category" class="block text-sm font-medium mb-1">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            <select id="category" required
                    class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500">
              <option value="" disabled selected>‚Äî –∏–∑–±–µ—Ä–µ—Ç–µ ‚Äî</option>
            </select>
          </div>

          <div>
            <label for="city" class="block text-sm font-medium mb-1">–ì—Ä–∞–¥ / –ù–∞—Å–µ–ª–µ–Ω–æ –º—è—Å—Ç–æ</label>
            <input id="city" type="text"
                   class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                   placeholder="–°–æ—Ñ–∏—è">
          </div>

          <div>
            <label for="price" class="block text-sm font-medium mb-1">–¶–µ–Ω–∞ (—á–∏—Å–ª–æ)</label>
            <input id="price" type="number" step="0.01" min="0" required
                   class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                   placeholder="0.00">
          </div>

          <div class="md:col-span-2">
            <label for="description" class="block text-sm font-medium mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea id="description" required rows="5"
                      class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                      placeholder="–û–ø–∏—à–µ—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ‚Ä¶"></textarea>
            <p class="text-xs text-slate-500 mt-1">–°—ä–≤–µ—Ç: –≤–∫–ª—é—á–µ—Ç–µ –∫–ª—é—á–æ–≤–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏, —Å—ä—Å—Ç–æ—è–Ω–∏–µ, –ª–æ–∫–∞—Ü–∏—è –∏ —É—Å–ª–æ–≤–∏—è.</p>
          </div>
        </div>

        <!-- –°–ù–ò–ú–ö–ò -->
        <div>
          <div class="flex items-center justify-between mb-1">
            <label class="block text-sm font-medium">–°–Ω–∏–º–∫–∏</label>
            <span id="imgCount" class="text-xs text-slate-500">0 / 6</span>
          </div>
          <div id="dropzone"
               class="border-2 border-dashed rounded-xl p-5 md:p-6 text-center text-slate-600 hover:bg-slate-50 cursor-pointer">
            –ü–ª—ä–∑–Ω–µ—Ç–µ —Å–Ω–∏–º–∫–∏ —Ç—É–∫ –∏–ª–∏ –∫–ª–∏–∫–Ω–µ—Ç–µ –∑–∞ –∏–∑–±–æ—Ä
            <input id="images" type="file" accept="image/*" multiple class="sr-only">
          </div>

          <!-- –ü—Ä–µ–≥–ª–µ–¥–∏ —Å –∏–∑–±–æ—Ä –Ω–∞ –æ—Å–Ω–æ–≤–Ω–∞ —Å–Ω–∏–º–∫–∞ -->
          <div id="previews" class="mt-3 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"></div>
          <p class="text-xs text-slate-500 mt-2">–î–æ 6 —Ñ–∞–π–ª–∞, –º–∞–∫—Å–∏–º—É–º 10MB –≤—Å—è–∫–∞. –ü—ä—Ä–≤–∞—Ç–∞ –µ –æ—Å–Ω–æ–≤–Ω–∞ (–º–æ–∂–µ –¥–∞ —Å–º–µ–Ω–∏—Ç–µ).</p>
        </div>

        <!-- –ü–õ–ê–ù–û–í–ï + –í–ê–õ–£–¢–ê -->
        <div>
          <div class="flex flex-col md:flex-row md:items-end gap-4">
            <div class="flex-1">
              <label class="block text-sm font-medium mb-2">–ò–∑–±–µ—Ä–µ—Ç–µ –ø–ª–∞–Ω</label>
              <div id="plansBar"
                   class="flex gap-5 overflow-x-auto pb-3 scrollbar-thin snap-x snap-mandatory">
                <!-- –∫–∞—Ä—Ç–∏—Ç–µ —Å–µ –∏–Ω–∂–µ–∫—Ç–∏—Ä–∞—Ç –æ—Ç JS -->
              </div>
            </div>

            <div class="w-full md:w-44">
              <label class="block text-sm font-medium mb-1">–í–∞–ª—É—Ç–∞</label>
              <div id="currencySwitch"
                   class="flex w-full md:inline-flex rounded-xl border bg-white shadow-sm overflow-hidden">
                <button type="button" data-cur="bgn"
                        class="curBtn flex-1 px-3 py-2 text-sm font-medium aria-selected:bg-emerald-600 aria-selected:text-white">
                  üáßüá¨ BGN
                </button>
                <button type="button" data-cur="eur"
                        class="curBtn flex-1 px-3 py-2 text-sm font-medium text-slate-600">
                  üá™üá∫ EUR
                </button>
              </div>
            </div>
          </div>
          <p class="text-xs text-slate-500 mt-2">–ü–ª–∞–Ω—ä—Ç –æ–ø—Ä–µ–¥–µ–ª—è –≤–∏–¥–∏–º–æ—Å—Ç –∏ –¥–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∏ –æ–ø—Ü–∏–∏. –ü–ª–∞—â–∞–Ω–µ—Ç–æ —Å–µ –ø—Ä–∞–≤–∏ —Å–ª–µ–¥ –∏–∑–ø—Ä–∞—â–∞–Ω–µ.</p>
        </div>

        <!-- –û—Å–Ω–æ–≤–µ–Ω submit (—Å–∫—Ä–∏—Ç –Ω–∞ –º–æ–±–∏–ª–Ω–∏, –≤–∏–¥–∏–º –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø) -->
        <button type="submit"
                class="hidden md:block w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-lg font-medium">
          –ò–∑–ø—Ä–∞—Ç–∏ –∑–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ
        </button>

        <p id="msg" class="text-center text-sm" aria-live="polite"></p>
      </form>

      <!-- –†–ï–ó–£–õ–¢–ê–¢ -->
      <div id="result" class="mt-6 hidden">
        <div class="p-4 rounded-xl border bg-emerald-50 text-emerald-800">
          <div class="font-semibold">–£—Å–ø–µ—à–Ω–æ –∏–∑–ø—Ä–∞—Ç–µ–Ω–∞!</div>
          <p class="text-sm">–û–±—è–≤–∞—Ç–∞ –µ –∑–∞–ø–∏—Å–∞–Ω–∞ –∏ —á–∞–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä.</p>
        </div>
        <div class="mt-4 grid gap-3 md:grid-cols-2">
          <a id="payBtn" target="_blank" rel="noopener"
             class="text-center px-4 py-3 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">–ü—Ä–µ–º–∏–Ω–∏ –∫—ä–º –ø–ª–∞—â–∞–Ω–µ</a>
          <a id="viewBtn" class="text-center px-4 py-3 rounded-lg border hover:bg-slate-50">–ü—Ä–µ–≥–ª–µ–¥ –Ω–∞ –æ–±—è–≤–∞—Ç–∞</a>
        </div>
      </div>
    </div>
  </main>

  <!-- Sticky action bar ‚Äî –º–æ–±–∏–ª–Ω–∏ -->
  <div id="stickyBar" class="md:hidden fixed bottom-0 inset-x-0 bg-white/95 backdrop-blur border-t p-3">
    <div class="max-w-4xl mx-auto px-2">
      <button id="stickySubmit"
              class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-lg font-medium">
        –ò–∑–ø—Ä–∞—Ç–∏ –∑–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ
      </button>
    </div>
  </div>

  <script>
    const sb = supabase.createClient(window.ENV.SUPABASE_URL, window.ENV.SUPABASE_ANON_KEY);

    const CATEGORIES = [
      '–ù–µ–¥–≤–∏–∂–∏–º–∏ –∏–º–æ—Ç–∏','–ê–≤—Ç–æ–º–æ–±–∏–ª–∏','–†–∞–±–æ—Ç–∞','–£—Å–ª—É–≥–∏','–¢–µ—Ö–Ω–∏–∫–∞',
      '–î–æ–º –∏ –≥—Ä–∞–¥–∏–Ω–∞','–ñ–∏–≤–æ—Ç–Ω–∏','–ú–æ–¥–∞','–°–ø–æ—Ä—Ç','–ò–≥—Ä–∏ –∏ —Ö–æ–±–∏','–î—Ä—É–≥–∏'
    ];

    // Fallback –ø–ª–∞–Ω–æ–≤–µ —Å BGN/EUR –ª–∏–Ω–∫–æ–≤–µ (–ø–æ —Ç–≤–æ–∏—Ç–µ –ª–∏–Ω–∫–æ–≤–µ)
    const FALLBACK_PLANS = [
      {
        id: 'starter',
        name: 'Starter',
        price_bgn: 9.99,
        price_eur: 5.10,
        pay_url: {
          bgn: 'https://checkout.revolut.com/payment-link/b9d03509-71b2-4c35-8d3a-43357e663650',
          eur: 'https://checkout.revolut.com/payment-link/f776550f-0424-4656-aacb-3c1f06c6014b'
        },
        features: ['–ü—É–±–ª–∏–∫—É–≤–∞–Ω–µ 30 –¥–Ω–∏','–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –≤–∏–¥–∏–º–æ—Å—Ç']
      },
      {
        id: 'pro',
        name: 'Pro',
        price_bgn: 19.99,
        price_eur: 10.22,
        pay_url: {
          bgn: 'https://checkout.revolut.com/payment-link/b0cc7f69-9a29-4559-8eed-a06ffc1b2604',
          eur: 'https://checkout.revolut.com/payment-link/62ddc3ea-6192-4b5d-875b-a90d80235edf'
        },
        features: ['–ü—É–±–ª–∏–∫—É–≤–∞–Ω–µ 60 –¥–Ω–∏','–ü–æ–≤–∏—à–µ–Ω–∞ –≤–∏–¥–∏–º–æ—Å—Ç','–¢–æ–ø']
      },
      {
        id: 'max',
        name: 'Max',
        price_bgn: 39.99,
        price_eur: 20.45,
        pay_url: {
          bgn: 'https://checkout.revolut.com/payment-link/e336d64c-7c6a-4962-a7ba-0f9a0e8f3a10',
          eur: 'https://checkout.revolut.com/payment-link/cc4190df-60c1-4f8c-9d3a-c0a949dbb527'
        },
        features: ['–ü—É–±–ª–∏–∫—É–≤–∞–Ω–µ 90 –¥–Ω–∏','–ú–∞–∫—Å. –≤–∏–¥–∏–º–æ—Å—Ç','–ó–∞–∫—Ä–µ–ø–≤–∞–Ω–µ']
      }
    ];

    const el = (id) => document.getElementById(id);
    const msg = (text, err=false) => {
      const m = el('msg');
      m.textContent = text;
      m.className = 'text-center text-sm ' + (err ? 'text-rose-600' : 'text-slate-600');
    };

    let currentUser = null;
    let plans = [];           // –æ—Ç –ë–î –∏–ª–∏ fallback
    let selectedPlan = null;  // —Ç–µ–∫—É—â–æ –∏–∑–±—Ä–∞–Ω –ø–ª–∞–Ω
    let selectedFiles = [];   // File[]
    let currentCurrency = 'bgn'; // 'bgn' | 'eur'
    let selectedCoverIndex = 0;  // –∏–Ω–¥–µ–∫—Å –Ω–∞ –æ—Å–Ω–æ–≤–Ω–∞—Ç–∞ —Å–Ω–∏–º–∫–∞

    (async () => {
      // 1) require login
      const { data: { user } } = await sb.auth.getUser();
      if (!user) { location.href = 'auth.html?redirectTo=' + encodeURIComponent(location.href); return; }
      currentUser = user;

      // 2) categories
      const catSel = el('category');
      CATEGORIES.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c; opt.textContent = c; catSel.appendChild(opt);
      });

      // 3) load plans table (–∞–∫–æ –∏–º–∞), –∏–Ω–∞—á–µ fallback
      try {
        const { data, error } = await sb
          .from('plans')
          .select('id,name,price,pay_url,features,price_bgn,price_eur');
        if (!error && data?.length) {
          plans = data.map(p => {
            // –ø–æ–¥–¥—Ä—ä–∂–∫–∞ –∞–∫–æ pay_url –µ json —Ç–µ–∫—Å—Ç
            let pay = p.pay_url;
            if (typeof pay === 'string' && pay.trim().startsWith('{')) {
              try { pay = JSON.parse(pay); } catch { pay = { bgn: pay, eur: pay }; }
            }
            if (typeof pay !== 'object') pay = { bgn: pay, eur: pay };
            return {
              id: p.id, name: p.name,
              price_bgn: Number(p.price_bgn ?? p.price),
              price_eur: Number(p.price_eur ?? p.price),
              pay_url: pay,
              features: p.features || []
            };
          });
        }
      } catch(_) {}
      if (!plans.length) plans = FALLBACK_PLANS;

      renderPlans();

      // 4) images handling
      const drop = el('dropzone'); const input = el('images');
      drop.addEventListener('click', ()=> input.click());
      drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('bg-slate-50'); });
      drop.addEventListener('dragleave', ()=> drop.classList.remove('bg-slate-50'));
      drop.addEventListener('drop', e => { e.preventDefault(); drop.classList.remove('bg-slate-50'); addFiles([...e.dataTransfer.files]); });
      input.addEventListener('change', e => addFiles([...e.target.files]));

      // 5) submit buttons
      el('adForm').addEventListener('submit', onSubmit);
      el('stickySubmit').addEventListener('click', ()=> el('adForm').requestSubmit());

      // 6) currency switch (BGN/EUR)
      document.querySelectorAll('#currencySwitch .curBtn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          currentCurrency = btn.dataset.cur; // 'bgn' | 'eur'
          document.querySelectorAll('#currencySwitch .curBtn')
            .forEach(b=>{
              const isSel = b === btn;
              b.setAttribute('aria-selected', isSel ? 'true' : 'false');
              b.classList.toggle('text-slate-600', !isSel);
              b.classList.toggle('text-white', isSel);
              b.classList.toggle('bg-emerald-600', isSel);
            });
          renderPlans();
        });
      });
      // –ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ BGN
      document.querySelector('#currencySwitch [data-cur="bgn"]').click();
    })();

    function renderPlans(){
      const bar = el('plansBar'); bar.innerHTML = '';
      const cur = currentCurrency; // 'bgn' | 'eur'

      plans.forEach((p) => {
        const price = cur === 'eur' ? Number(p.price_eur) : Number(p.price_bgn);
        const isSelected = selectedPlan?.id === p.id;

        const wrap = document.createElement('div');
        wrap.className = 'planWrap snap-start';

        const isPro = (p.name||'').toLowerCase() === 'pro';
        const badge = isPro
          ? `<span class="absolute -top-3 left-4 z-10 text-[11px] px-2 py-1 rounded-full bg-indigo-600 text-white shadow">–ù–∞–π-–ø–æ–ø—É–ª—è—Ä–µ–Ω</span>`
          : '';

        wrap.innerHTML = `
          ${badge}
          <button type="button"
                  class="relative group min-w-[85vw] sm:min-w-[260px] rounded-2xl border bg-white/70 backdrop-blur-md
                         hover:shadow-lg transition-all duration-300 p-5 text-left">
            <div class="flex items-center justify-between">
              <div class="text-lg md:text-xl font-semibold">${escapeHTML(p.name)}</div>
              <div class="text-base md:text-lg font-bold">
                <span class="bg-gradient-to-r from-emerald-600 to-indigo-600 bg-clip-text text-transparent">
                  ${isFinite(price) ? price.toFixed(2) : '‚Äî'} ${cur.toUpperCase()}
                </span>
              </div>
            </div>
            <ul class="mt-3 text-sm text-slate-600 space-y-1">
              ${(p.features||[]).map(f=>`<li class="flex items-center gap-2">
                  <svg width="16" height="16" viewBox="0 0 24 24" class="shrink-0 text-emerald-600">
                    <path fill="currentColor" d="M9 16.2 4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"/>
                  </svg>${escapeHTML(String(f))}
                </li>`).join('') || '<li class="text-slate-400">–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏ –µ–∫—Å—Ç—Ä–∏</li>'}
            </ul>
            <div class="mt-4">
              <span class="inline-flex items-center gap-1 text-xs px-3 py-1 rounded-lg
                           bg-slate-100 text-slate-700 group-hover:bg-slate-200 transition">
                –∏–∑–±–µ—Ä–∏
              </span>
            </div>
          </button>
        `;

        wrap.querySelector('button').addEventListener('click', ()=>{
          selectedPlan = p;
          [...bar.children].forEach(c=>c.classList.remove('is-selected'));
          wrap.classList.add('is-selected');
        });

        if (isSelected) wrap.classList.add('is-selected');
        bar.appendChild(wrap);
      });

      // –∞–∫–æ –Ω—è–º–∞ –∏–∑–±—Ä–∞–Ω ‚Üí –ø—ä—Ä–≤–∏—è
      if (!selectedPlan && bar.children.length) {
        bar.children[0].classList.add('is-selected');
        selectedPlan = plans[0];
      }
    }

    function addFiles(files){
      const MAX = 6;
      const filtered = [];
      for (const file of files) {
        if (!file.type.startsWith('image/')) continue;
        if (file.size > 10*1024*1024) { msg(`–§–∞–π–ª—ä—Ç ${file.name} –µ –Ω–∞–¥ 10MB –∏ –±–µ—à–µ –ø—Ä–æ–ø—É—Å–Ω–∞—Ç.`, true); continue; }
        filtered.push(file);
      }
      const remain = Math.max(0, MAX - selectedFiles.length);
      if (remain <= 0) { msg('–î–æ—Å—Ç–∏–≥–Ω–∞—Ç –µ –ª–∏–º–∏—Ç—ä—Ç –æ—Ç 6 —Å–Ω–∏–º–∫–∏.', true); return; }
      selectedFiles = selectedFiles.concat(filtered.slice(0, remain));

      // –∞–∫–æ –Ω—è–º–∞ –∏–∑–±—Ä–∞–Ω–∞ –æ—Å–Ω–æ–≤–Ω–∞ ‚Äî –ø—ä—Ä–≤–∞—Ç–∞
      if (selectedFiles.length && (selectedCoverIndex == null || selectedCoverIndex >= selectedFiles.length)) {
        selectedCoverIndex = 0;
      }
      renderPreviews();
    }

    function renderPreviews(){
      const box = el('previews'); box.innerHTML = '';
      el('imgCount').textContent = `${selectedFiles.length} / 6`;

      selectedFiles.forEach((file, idx) => {
        const url = URL.createObjectURL(file);
        const isCover = idx === selectedCoverIndex;

        const wrap = document.createElement('div');
        wrap.className = 'relative group';

        wrap.innerHTML = `
          <img src="${url}"
               class="w-full h-28 object-cover rounded-lg border ${isCover ? 'ring-2 ring-indigo-500' : ''}">
          <button type="button"
                  class="absolute top-1 left-1 text-[11px] px-2 py-1 rounded bg-indigo-600 text-white ${isCover ? '' : 'hidden'}">
            –û—Å–Ω–æ–≤–Ω–∞
          </button>

          <div class="absolute bottom-1 left-1 flex gap-1">
            <button type="button" data-make="${idx}"
                    class="bg-white/90 border rounded-md px-2 py-1 text-xs ${isCover ? 'hidden' : ''}">
              –ù–∞–ø—Ä–∞–≤–∏ –æ—Å–Ω.
            </button>
          </div>

          <button type="button"
                  class="absolute top-1 right-1 bg-white/90 border rounded-md px-2 py-1 text-xs">
            –ü—Ä–µ–º–∞—Ö–Ω–∏
          </button>
        `;

        // –ø—Ä–µ–º–∞—Ö–≤–∞–Ω–µ
        wrap.querySelector('.absolute.top-1.right-1')?.addEventListener('click', ()=>{
          selectedFiles.splice(idx,1);
          // –∫–æ—Ä–∏–≥–∏—Ä–∞–π cover –∏–Ω–¥–µ–∫—Å–∞
          if (selectedFiles.length === 0) {
            selectedCoverIndex = 0;
          } else if (idx < selectedCoverIndex) {
            selectedCoverIndex -= 1;
          } else if (idx === selectedCoverIndex) {
            selectedCoverIndex = 0;
          }
          renderPreviews();
        });

        // –Ω–∞–ø—Ä–∞–≤–∏ –æ—Å–Ω–æ–≤–Ω–∞
        wrap.querySelector(`[data-make="${idx}"]`)?.addEventListener('click', ()=>{
          selectedCoverIndex = idx;
          renderPreviews();
        });

        box.appendChild(wrap);
      });
    }

    async function onSubmit(e){
      e.preventDefault(); msg('');
      const title = el('title').value.trim();
      const description = el('description').value.trim();
      const category = el('category').value;
      const city = el('city').value.trim();
      const price = parseFloat(el('price').value);
      const currency = currentCurrency; // 'bgn' | 'eur'

      if (!title || !description || !category || isNaN(price)) { msg('–ü–æ–ø—ä–ª–Ω–µ—Ç–µ –≤—Å–∏—á–∫–∏ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∏ –ø–æ–ª–µ—Ç–∞.', true); return; }
      if (!selectedPlan) { msg('–ú–æ–ª—è, –∏–∑–±–µ—Ä–µ—Ç–µ –ø–ª–∞–Ω.', true); return; }

      // 1) –∫–∞—á–∏ —Å–Ω–∏–º–∫–∏—Ç–µ
      let image_urls = [];
      if (selectedFiles.length){
        const uploaded = await uploadImages(selectedFiles);
        if (uploaded.error) { msg(uploaded.error, true); return; }
        image_urls = uploaded.urls;
      }

      // –æ–ø—Ä–µ–¥–µ–ª—è–Ω–µ –Ω–∞ cover url —Å–ø–æ—Ä–µ–¥ –∏–Ω–¥–µ–∫—Å–∞
      const cover_index = Math.min(Math.max(selectedCoverIndex || 0, 0), Math.max(image_urls.length - 1, 0));
      const cover_image = image_urls[cover_index] || null;

      // 2) –∑–∞–ø–∏—Å –≤ ads (pending)
      const plan_price = currency === 'eur' ? Number(selectedPlan.price_eur) : Number(selectedPlan.price_bgn);
      const insertPayload = {
        user_id: currentUser.id,
        title, description, price, city, category,
        images: image_urls,                     // jsonb
        cover_image,                            // —Ç–µ–∫—Å—Ç–æ–≤ URL (–ø–æ –∏–∑–±–æ—Ä)
        cover_index,                            // —á–∏—Å–ª–æ (–ø–æ –∏–∑–±–æ—Ä)
        plan_id: selectedPlan.id,
        plan_name: selectedPlan.name,
        plan_price: plan_price,
        plan_currency: currency.toUpperCase(),  // BGN/EUR
        ad_status: 'pending'
      };

      const { data, error } = await sb.from('ads').insert([insertPayload]).select('id').single();
      if (error) { console.error(error); msg('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å. –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –ø—Ä–∞–≤–∞—Ç–∞ (RLS) –∏ –ø–æ–ª–µ—Ç–∞—Ç–∞ –≤ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞.', true); return; }

      // 3) —Ä–µ–∑—É–ª—Ç–∞—Ç + –±—É—Ç–æ–Ω –∑–∞ –ø–ª–∞—â–∞–Ω–µ —Å–ø–æ—Ä–µ–¥ –≤–∞–ª—É—Ç–∞—Ç–∞
      el('adForm').classList.add('hidden');
      el('stickyBar').classList.add('hidden'); // —Å–∫—Ä–∏–π –º–æ–±–∏–ª–Ω–∏—è –±–∞—Ä
      const res = el('result'); res.classList.remove('hidden');
      el('viewBtn').href = 'ad.html?id=' + encodeURIComponent(data.id);

      const payBtn = el('payBtn');
      const payUrl = selectedPlan?.pay_url?.[currency];
      if (payUrl) {
        payBtn.href = payUrl;
        payBtn.textContent = '–ü—Ä–µ–º–∏–Ω–∏ –∫—ä–º –ø–ª–∞—â–∞–Ω–µ (' + currency.toUpperCase() + ')';
      } else {
        payBtn.href = '#';
        payBtn.classList.add('pointer-events-none','opacity-60');
        payBtn.textContent = '–ù—è–º–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø–ª–∞—Ç–µ–∂–µ–Ω –ª–∏–Ω–∫';
      }

      msg('');
      window.scrollTo({top:0, behavior:'smooth'});
    }

    async function uploadImages(files){
      try{
        const urls = [];
        for (const f of files){
          const ext = (f.name.split('.').pop() || 'jpg').toLowerCase();
          const path = `${currentUser.id}/${crypto.randomUUID()}.${ext}`;
          const { error: upErr } = await sb.storage.from('ad-images').upload(path, f, { upsert: false, contentType: f.type });
          if (upErr) return { error: '–ö–∞—á–≤–∞–Ω–µ—Ç–æ –ø—Ä–µ–∫—ä—Å–Ω–∞: ' + upErr.message };
          const { data: pub } = sb.storage.from('ad-images').getPublicUrl(path);
          urls.push(pub.publicUrl);
        }
        return { urls };
      }catch(err){
        console.error(err);
        return { error: '–ù–µ—É—Å–ø–µ—à–Ω–æ –∫–∞—á–≤–∞–Ω–µ –Ω–∞ —Å–Ω–∏–º–∫–∏.' };
      }
    }

    function escapeHTML(s){
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');
    }
  </script>

  <!-- –ü–æ –∏–∑–±–æ—Ä: –¥–æ–±–∞–≤–∏ –≤ –ë–î —Ç–µ–∑–∏ –∫–æ–ª–æ–Ω–∏, –∞–∫–æ –≥–∏ –Ω—è–º–∞:
  alter table public.ads
    add column if not exists cover_image text,
    add column if not exists cover_index int;
  -->
</body>
</html>
