<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NovaObqva — Публикувай</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="env.js"></script>
</head>
<body class="bg-slate-50 min-h-screen">
  <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b">
    <div class="max-w-3xl mx-auto p-4 flex items-center gap-4">
      <a href="/" class="text-2xl font-bold">NovaObqva</a>
      <div class="flex-1"></div>
    </div>
  </header>

  <main class="max-w-3xl mx-auto p-4" id="root">
    <!-- формата се рендерира след проверка за вход -->
  </main>

  <!-- FAB мобилно -->
  <div class="fixed z-50 bottom-4 right-4 flex flex-col gap-3 md:hidden">
    <a href="index.html" class="rounded-full px-4 py-3 bg-slate-800 text-white shadow-lg">Начало</a>
    <a href="account.html" class="rounded-full px-4 py-3 bg-indigo-600 text-white shadow-lg">Профил</a>
  </div>

  <script>
    const supabaseClient = supabase.createClient(window.ENV.SUPABASE_URL, window.ENV.SUPABASE_ANON_KEY);

    // Общ мини-скрипт за навигация
    (async () => {
      const { data: { user } } = await supabaseClient.auth.getUser();
      const header = document.querySelector('header .max-w-3xl') || document.querySelector('header div');
      if (header) {
        const container = document.createElement('div');
        container.className = "flex items-center gap-3";
        if (user) {
          container.innerHTML = `
            <a href="account.html" class="px-3 py-1.5 rounded-lg border bg-white hover:bg-slate-50 text-sm">Моят профил</a>
            <button id="logoutBtn" class="px-3 py-1.5 rounded-lg bg-slate-800 text-white text-sm">Изход</button>
          `;
        } else {
          const redirect = encodeURIComponent(location.href);
          container.innerHTML = `<a href="auth.html?redirectTo=${redirect}" class="px-3 py-1.5 rounded-lg bg-emerald-600 text-white text-sm">Вход</a>`;
        }
        header.appendChild(container);
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) logoutBtn.addEventListener('click', async () => { await supabaseClient.auth.signOut(); location.reload(); });
      }

      // Gate: изисква вход
      if (!user) {
        document.getElementById('root').innerHTML = `
          <div class="bg-white rounded-2xl border p-6 text-center">
            <h1 class="text-xl font-semibold mb-2">Нужен е вход</h1>
            <p class="text-slate-600 mb-4">Моля, влез с Google, за да публикуваш обява.</p>
            <a href="auth.html?redirectTo=${encodeURIComponent(location.href)}" class="px-4 py-2 rounded-xl bg-emerald-600 text-white">Вход</a>
          </div>`;
        return;
      }

      // Рендер на формата
      document.getElementById('root').innerHTML = `
        <h1 class="text-xl font-semibold mb-4">Публикувай нова обява</h1>
        <form id="form" class="space-y-4 bg-white p-4 rounded-2xl border">
          <div>
            <label class="block mb-1 font-medium">Заглавие</label>
            <input name="title" required class="w-full px-4 py-2 rounded-xl border" placeholder="Кратко и ясно заглавие" />
          </div>
          <div>
            <label class="block mb-1 font-medium">Описание</label>
            <textarea name="description" required rows="5" class="w-full px-4 py-2 rounded-xl border" placeholder="Подробности, състояние, размери..."></textarea>
          </div>
          <div class="grid sm:grid-cols-3 gap-4">
            <div>
              <label class="block mb-1 font-medium">Цена (лв.)</label>
              <input name="price" type="number" min="0" step="0.01" required class="w-full px-4 py-2 rounded-xl border" />
            </div>
            <div>
              <label class="block mb-1 font-medium">Категория</label>
              <select name="category_id" id="cat" required class="w-full px-4 py-2 rounded-xl border"></select>
            </div>
            <div>
              <label class="block mb-1 font-medium">Местоположение</label>
              <input name="location" class="w-full px-4 py-2 rounded-xl border" placeholder="гр./с. ..." />
            </div>
          </div>
          <div class="grid sm:grid-cols-3 gap-4">
            <div>
              <label class="block mb-1 font-medium">Име за контакт</label>
              <input name="contact_name" class="w-full px-4 py-2 rounded-xl border" />
            </div>
            <div>
              <label class="block mb-1 font-medium">Телефон</label>
              <input name="contact_phone" class="w-full px-4 py-2 rounded-xl border" />
            </div>
            <div>
              <label class="block mb-1 font-medium">Имейл</label>
              <input name="contact_email" type="email" class="w-full px-4 py-2 rounded-xl border" />
            </div>
          </div>
          <div>
            <label class="block mb-1 font-medium">Снимки (до 6)</label>
            <input id="photos" type="file" accept="image/*" multiple class="w-full" />
            <p class="text-xs text-slate-500 mt-1">Първата снимка ще е корица. Максимум 6 снимки.</p>
          </div>
          <div class="flex justify-end gap-3">
            <a href="/" class="px-4 py-2 rounded-xl border">Отказ</a>
            <button class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">Изпрати за одобрение</button>
          </div>
        </form>`;

      // категории
      const { data: cats } = await supabaseClient.from('categories').select('id,name').order('name');
      const catEl = document.getElementById('cat');
      catEl.innerHTML = '<option value="" disabled selected>Избери...</option>' + (cats||[]).map(c=>`<option value="${c.id}">${c.name}</option>`).join('');

      // submit
      document.getElementById('form').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(e.currentTarget);
        const record = Object.fromEntries(fd.entries());
        record.price = Number(record.price||0);
        record.status = 'pending';

        const { data: ad, error } = await supabaseClient.from('ads').insert(record).select('id').single();
        if(error){ alert('Грешка при запис на обявата'); console.error(error); return; }

        const files = document.getElementById('photos').files;
        const MAX = 6;
        const toUpload = Array.from(files).slice(0, MAX);
        for (const [i,f] of toUpload.entries()){
          const ext = f.name.split('.').pop();
          const path = `${ad.id}/${crypto.randomUUID()}.${ext}`;
          const { error: upErr } = await supabaseClient.storage.from('ad-images').upload(path, f, { upsert:false });
          if(upErr){ console.error(upErr); alert('Грешка при качване на снимка'); }
          else {
            const { data:pub } = supabaseClient.storage.from('ad-images').getPublicUrl(path);
            await supabaseClient.from('ad_images').insert({ ad_id: ad.id, url: pub.publicUrl, position: i });
          }
        }

        alert('Обявата е изпратена за одобрение!');
        location.href = 'index.html';
      });
    })();
  </script>
</body>
</html>
