<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NovaObqva — Admin</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="env.js"></script>
</head>
<body class="bg-slate-50 min-h-screen">
  <header class="sticky top-0 bg-white/80 backdrop-blur border-b z-40">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-4">
      <a href="/" class="flex items-center gap-2 text-2xl font-bold">
        <img src="/favicon.png" class="w-6 h-6 rounded" alt=""> NovaObqva
      </a>
      <div class="flex-1"></div>
      <a href="/account.html" class="px-4 py-2 rounded-xl border hover:bg-slate-50">Моят профил</a>
      <button id="logoutBtn" class="px-4 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900">Изход</button>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 md:p-6">
    <h1 class="text-2xl font-bold mb-4">Админ панел</h1>

    <div class="grid lg:grid-cols-3 gap-6">
      <!-- Pending (18-) -->
      <section class="lg:col-span-2 bg-white rounded-2xl border p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold">Чакащи обяви</h2>
          <input id="searchEmail" placeholder="търси по имейл…" class="border rounded-lg px-3 py-1.5 text-sm">
        </div>
        <div id="adsPending" class="space-y-3"></div>
      </section>

      <!-- Approved -->
      <section class="bg-white rounded-2xl border p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold">Публикувани</h2>
          <select id="approvedLimit" class="border rounded-lg px-2 py-1 text-sm">
            <option value="10">Последни 10</option>
            <option value="25">25</option>
            <option value="50">50</option>
          </select>
        </div>
        <div id="adsApproved" class="space-y-3"></div>
      </section>
    </div>

    <!-- 18+ Pending -->
    <section class="mt-6 bg-white rounded-2xl border p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold flex items-center gap-2">
          18+ чакащи
          <span class="text-[11px] px-2 py-0.5 rounded-full bg-rose-100 text-rose-800 border border-rose-200">възрастово ограничено</span>
        </h2>
        <input id="searchEmailAdult" placeholder="търси по имейл…" class="border rounded-lg px-3 py-1.5 text-sm">
      </div>
      <div id="adsAdultPending" class="space-y-3"></div>
    </section>
  </main>

  <!-- Preview modal -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative bg-white max-w-3xl w-[90%] rounded-2xl border shadow-lg overflow-hidden">
      <div class="flex items-center justify-between p-4 border-b">
        <div class="font-semibold flex items-center gap-2" id="mTitle">
          Преглед
          <span id="mAdultBadge" class="hidden text-[11px] px-2 py-0.5 rounded-full bg-rose-100 text-rose-800 border border-rose-200">18+</span>
        </div>
        <button id="mClose" class="p-2 rounded-md hover:bg-slate-100">✕</button>
      </div>
      <div class="p-4 grid md:grid-cols-3 gap-4">
        <div class="md:col-span-2 space-y-3">
          <div class="text-xl font-semibold" id="mAdTitle"></div>
          <div class="text-slate-600 text-sm" id="mMeta"></div>
          <div class="text-slate-700 whitespace-pre-wrap" id="mDesc"></div>
          <div id="mImages" class="grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
        </div>
        <aside class="space-y-3">
          <div class="rounded-xl border p-3">
            <div class="text-sm text-slate-500 mb-2">План & плащане</div>
            <div id="mPlan" class="font-medium"></div>
            <div class="text-slate-700" id="mPrice"></div>
            <div class="mt-2">
              <span id="mPayStatus" class="inline-block text-xs px-2 py-1 rounded bg-slate-100"></span>
            </div>
            <div class="mt-3 flex gap-2">
              <button id="btnMarkPaid" class="px-3 py-2 rounded-lg bg-emerald-600 text-white">Маркирай „платено“</button>
              <a id="btnPayLink" target="_blank" class="px-3 py-2 rounded-lg border hover:bg-slate-50">Към плащане</a>
            </div>
          </div>

          <div class="rounded-xl border p-3">
            <div class="text-sm text-slate-500 mb-2">Контакти</div>
            <div id="mContact" class="space-y-1 text-slate-700"></div>
          </div>

          <div class="rounded-xl border p-3">
            <div class="text-sm text-slate-500 mb-2">Действия</div>
            <div class="flex flex-wrap gap-2">
              <button id="mApprove" class="px-3 py-2 bg-emerald-600 text-white rounded-lg">Одобри</button>
              <button id="mReject" class="px-3 py-2 bg-rose-600 text-white rounded-lg">Откажи</button>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <!-- Edit modal -->
  <div id="editModal" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <form id="editForm" class="relative bg-white max-w-2xl w-[92%] rounded-2xl border shadow-lg overflow-hidden">
      <div class="flex items-center justify-between p-4 border-b">
        <div class="font-semibold">Редакция на обява</div>
        <button type="button" id="eClose" class="p-2 rounded-md hover:bg-slate-100">✕</button>
      </div>
      <div class="p-4 grid gap-3">
        <input type="hidden" id="eId">
        <label class="grid gap-1">
          <span class="text-sm text-slate-600">Заглавие</span>
          <input id="eTitle" class="border rounded-lg px-3 py-2" required>
        </label>
        <div class="grid md:grid-cols-3 gap-3">
          <label class="grid gap-1">
            <span class="text-sm text-slate-600">Цена</span>
            <input id="ePrice" type="number" step="0.01" class="border rounded-lg px-3 py-2" required>
          </label>
          <label class="grid gap-1">
            <span class="text-sm text-slate-600">Град</span>
            <input id="eCity" class="border rounded-lg px-3 py-2">
          </label>
          <label class="grid gap-1">
            <span class="text-sm text-slate-600">Категория</span>
            <input id="eCategory" class="border rounded-lg px-3 py-2">
          </label>
        </div>
        <label class="grid gap-1">
          <span class="text-sm text-slate-600">Описание</span>
          <textarea id="eDesc" rows="6" class="border rounded-lg px-3 py-2"></textarea>
        </label>
        <div class="grid md:grid-cols-2 gap-3">
          <label class="grid gap-1">
            <span class="text-sm text-slate-600">План</span>
            <input id="ePlan" class="border rounded-lg px-3 py-2" placeholder="Starter / Pro / Max / Gold">
          </label>
          <label class="grid gap-1">
            <span class="text-sm text-slate-600">Валута на плана</span>
            <input id="ePlanCur" class="border rounded-lg px-3 py-2" placeholder="BGN / EUR">
          </label>
        </div>
        <div class="flex items-center justify-between pt-2">
          <div class="text-xs text-slate-500">* Редакцията е видима веднага.</div>
          <div class="flex gap-2">
            <button type="button" id="eHide" class="px-3 py-2 rounded-lg border text-rose-700 hover:bg-rose-50">Скрий обявата</button>
            <button type="submit" class="px-4 py-2 rounded-lg bg-emerald-600 text-white">Запази</button>
          </div>
        </div>
      </div>
    </form>
  </div>

  <script>
    // ====== CONFIG ======
    const ADMIN_EMAIL = 'uzunov.ange@gmail.com';
    const EXRATE_EUR_BGN = 1.95583; // фиксиран курс
    const sb = supabase.createClient(window.ENV.SUPABASE_URL, window.ENV.SUPABASE_ANON_KEY);

    const FALLBACK_PLANS = [
      { id:'starter', name:'Starter', price_bgn:9.99, price_eur:5.10,
        pay_url:{ bgn:'https://checkout.revolut.com/payment-link/b9d03509-71b2-4c35-8d3a-43357e663650',
                  eur:'https://checkout.revolut.com/payment-link/f776550f-0424-4656-aacb-3c1f06c6014b' } },
      { id:'pro', name:'Pro', price_bgn:19.99, price_eur:10.22,
        pay_url:{ bgn:'https://checkout.revolut.com/payment-link/b0cc7f69-9a29-4559-8eed-a06ffc1b2604',
                  eur:'https://checkout.revolut.com/payment-link/62ddc3ea-6192-4b5d-875b-a90d80235edf' } },
      { id:'max', name:'Max', price_bgn:39.99, price_eur:20.45,
        pay_url:{ bgn:'https://checkout.revolut.com/payment-link/e336d64c-7c6a-4962-a7ba-0f9a0e8f3a10',
                  eur:'https://checkout.revolut.com/payment-link/cc4190df-60c1-4f8c-9d3a-c0a949dbb527' } }
    ];
    let PLAN_MAP = {};

    function fmtBGN(n){ try{ return new Intl.NumberFormat('bg-BG',{style:'currency',currency:'BGN'}).format(Number(n)||0); }catch{ return `${Number(n||0).toFixed(2)} лв.`; } }
    function fmtEUR(n){ try{ return new Intl.NumberFormat('bg-BG',{style:'currency',currency:'EUR'}).format(Number(n)||0); }catch{ return `${Number(n||0).toFixed(2)} €`; } }
    function dual(amount, currency){
      const cur = String(currency||'BGN').toUpperCase();
      const val = Number(amount)||0;
      if (cur === 'EUR') return `${fmtEUR(val)}  ·  ${fmtBGN(val*EXRATE_EUR_BGN)}`;
      return `${fmtBGN(val)}  ·  ${fmtEUR(val/EXRATE_EUR_BGN)}`;
    }

    // ====== INIT / GUARD ======
    (async () => {
      const { data:{ user } } = await sb.auth.getUser();
      if (!user) { location.href = 'auth.html?redirectTo=' + encodeURIComponent(location.href); return; }
      if ((user.email||'').toLowerCase() !== ADMIN_EMAIL) { location.href = '/'; return; }

      document.getElementById('logoutBtn').onclick = async () => { await sb.auth.signOut(); location.href='/'; };

      // Plans map
      try {
        const { data, error } = await sb.from('plans').select('id,name,pay_url,price_bgn,price_eur');
        if (!error && data?.length) {
          for (const p of data) {
            let pay = p.pay_url;
            if (typeof pay === 'string') { try{ pay = JSON.parse(pay); }catch{ pay = {}; } }
            PLAN_MAP[p.id] = { ...p, pay_url: pay };
            PLAN_MAP[p.name?.toLowerCase?.()] = PLAN_MAP[p.id];
          }
        }
      } catch(_) {}
      if (Object.keys(PLAN_MAP).length === 0) {
        for (const p of FALLBACK_PLANS) {
          PLAN_MAP[p.id] = p; PLAN_MAP[p.name.toLowerCase()] = p;
        }
      }

      await loadPending();
      await loadApproved();
      await loadAdultPending();

      document.getElementById('searchEmail').addEventListener('input', () => loadPending());
      document.getElementById('approvedLimit').addEventListener('change', () => loadApproved());
      document.getElementById('searchEmailAdult').addEventListener('input', () => loadAdultPending());
    })();

    // ====== LOADERS ======
    async function loadPending(){
      const qEmail = document.getElementById('searchEmail').value.trim().toLowerCase();
      // основен филтър: ad_status=pending И (is_adult=false или null)
      let data = [], error = null;
      try {
        let q = sb.from('ads').select(`
          id,title,price,city,category,created_at,is_adult,
          contact_name,contact_phone,contact_email,posted_by_email,
          plan_name,plan_currency,plan_price,payment_status
        `).eq('ad_status','pending').or('is_adult.is.false,is_adult.is.null').order('created_at',{ascending:true});
        if (qEmail) q = q.ilike('posted_by_email','%' + qEmail + '%');
        ({ data, error } = await q);
        if (error) throw error;
      } catch(e) {
        // fallback: няма is_adult колона -> филтрираме по категория без да разделяме
        let q = sb.from('ads').select(`
          id,title,price,city,category,created_at,
          contact_name,contact_phone,contact_email,posted_by_email,
          plan_name,plan_currency,plan_price,payment_status
        `).eq('ad_status','pending').order('created_at',{ascending:true});
        if (qEmail) q = q.ilike('posted_by_email','%' + qEmail + '%');
        const res = await q;
        data = (res.data||[]).filter(r => !/18\+|adult|erot/i.test(r.category||''));
      }

      const wrap = document.getElementById('adsPending');
      wrap.innerHTML = (data||[]).map(r => cardPending(r)).join('') || '<p class="text-slate-500">Няма чакащи.</p>';
    }

    async function loadAdultPending(){
      const qEmail = document.getElementById('searchEmailAdult').value.trim().toLowerCase();
      let data = [], error = null;
      try {
        let q = sb.from('ads').select(`
          id,title,price,city,category,created_at,is_adult,
          contact_name,contact_phone,contact_email,posted_by_email,
          plan_name,plan_currency,plan_price,payment_status
        `).eq('ad_status','pending').eq('is_adult', true).order('created_at',{ascending:true});
        if (qEmail) q = q.ilike('posted_by_email','%' + qEmail + '%');
        ({ data, error } = await q);
        if (error) throw error;
      } catch(e) {
        // fallback: търсим по категория 18+
        let q = sb.from('ads').select(`
          id,title,price,city,category,created_at,
          contact_name,contact_phone,contact_email,posted_by_email,
          plan_name,plan_currency,plan_price,payment_status
        `).eq('ad_status','pending').order('created_at',{ascending:true});
        if (qEmail) q = q.ilike('posted_by_email','%' + qEmail + '%');
        const res = await q;
        data = (res.data||[]).filter(r => /18\+|adult|erot/i.test(r.category||''));
      }

      const wrap = document.getElementById('adsAdultPending');
      wrap.innerHTML = (data||[]).map(r => cardPending(r, true)).join('') || '<p class="text-slate-500">Няма 18+ чакащи.</p>';
    }

    async function loadApproved(){
      const limit = Number(document.getElementById('approvedLimit').value || 10);
      const { data, error } = await sb
        .from('ads')
        .select('id,title,price,city,category,approved_at,plan_currency,plan_name,contact_email,images,cover_image,description,is_adult')
        .eq('ad_status','approved')
        .order('approved_at',{ascending:false})
        .limit(limit);
      if (error) { console.error(error); return; }

      const wrap = document.getElementById('adsApproved');
      wrap.innerHTML = (data||[]).map(r => cardApproved(r)).join('') || '<p class="text-slate-500">Още няма.</p>';
    }

    // ====== CARDS ======
    function pill(status){
      const paid = status === 'paid' || status === 'manual';
      return `<span class="ml-2 text-xs px-2 py-0.5 rounded ${paid?'bg-emerald-100 text-emerald-800':'bg-amber-100 text-amber-800'}">${esc(status||'unpaid')}</span>`;
    }

    function adultBadge(r, compact=false){
      const isAdult = r?.is_adult === true || /18\+|adult|erot/i.test(r?.category||'');
      if (!isAdult) return '';
      return `<span class="${compact?'text-[10px] px-1.5 py-0.5':'text-[11px] px-2 py-0.5'} rounded-full bg-rose-100 text-rose-800 border border-rose-200">18+</span>`;
    }

    function cardPending(r, forceAdult=false){
      const currency = (r.plan_currency||'BGN').toUpperCase();
      const isAdult = forceAdult || r?.is_adult === true || /18\+|adult|erot/i.test(r?.category||'');
      return `
      <div class="border rounded-xl p-4 ${isAdult?'ring-1 ring-rose-200':''}">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="font-semibold text-lg mb-0.5 flex items-center gap-2">
              ${esc(r.title)} ${adultBadge(r)}
            </div>
            <div class="text-sm text-slate-500">Създадена: ${new Date(r.created_at).toLocaleString('bg-BG')}</div>
            <div class="text-sm text-slate-500">Потребител: ${esc(r.contact_name||'—')} · ${esc(r.contact_email||r.posted_by_email||'—')} · ${esc(r.contact_phone||'—')}</div>
            <div class="text-sm text-slate-500">Категория: ${esc(r.category||'—')} · Град: ${esc(r.city||'—')}</div>
            <div class="mt-1">
              <span class="text-slate-700">План: ${esc(r.plan_name||'—')} · ${dual(r.plan_price||0, currency)}</span>
              ${pill(r.payment_status)}
            </div>
          </div>
          <div class="flex flex-col items-end gap-2">
            <div class="flex gap-2">
              <button class="px-4 py-2 bg-emerald-600 text-white rounded-xl" onclick="approve('${r.id}', '${r.payment_status||''}')">Одобри</button>
              <button class="px-4 py-2 bg-rose-600 text-white rounded-xl" onclick="rejectAd('${r.id}')">Откажи</button>
              <button class="px-4 py-2 rounded-xl border" onclick="preview('${r.id}')">Виж</button>
            </div>
            <div class="text-emerald-700 font-bold">${fmtBGN(r.price)}</div>
          </div>
        </div>
      </div>`;
    }

    function cardApproved(r){
      const cur = (r.plan_currency||'BGN').toUpperCase();
      const when = r.approved_at ? new Date(r.approved_at).toLocaleString('bg-BG') : '—';
      return `
      <div class="border rounded-xl p-3 ${r?.is_adult ? 'ring-1 ring-rose-200' : ''}">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="font-medium flex items-center gap-2">${esc(r.title)} ${adultBadge(r,true)}</div>
            <div class="text-xs text-slate-500">Одобрена: ${when} · ${esc(r.city||'—')} · ${esc(r.category||'—')} · План: ${esc(r.plan_name||'—')} ${cur}</div>
          </div>
          <div class="flex gap-2">
            <button class="px-3 py-1.5 rounded-lg border hover:bg-slate-50" onclick="preview('${r.id}')">Преглед</button>
            <button class="px-3 py-1.5 rounded-lg bg-amber-500 text-white hover:bg-amber-600" onclick="openEdit('${r.id}')">Редакция</button>
            <button class="px-3 py-1.5 rounded-lg bg-rose-600 text-white hover:bg-rose-700" onclick="hideAd('${r.id}')">Премахни</button>
          </div>
        </div>
      </div>`;
    }

    // ====== ACTIONS ======
    async function approve(id, payStatus){
      // if (payStatus !== 'paid' && !confirm('Тази обява не е маркирана като платена. Да продължа с одобрение?')) return;
      const { error } = await sb.from('ads').update({ ad_status:'approved', approved_at: new Date().toISOString() }).eq('id', id);
      if (error) { alert('Отказано от сървъра. Нямаш права или грешка.'); console.error(error); return; }
      await loadPending(); await loadAdultPending(); await loadApproved();
    }
    async function rejectAd(id){
      if (!confirm('Сигурни ли сте, че отказвате обявата?')) return;
      const { error } = await sb.from('ads').update({ ad_status:'hidden' }).eq('id', id);
      if (error) { alert('Отказано от сървъра. Нямаш права или грешка.'); console.error(error); return; }
      await loadPending(); await loadAdultPending();
    }
    window.approve = approve; window.rejectAd = rejectAd;

    // ====== PREVIEW ======
    async function preview(id){
      const { data, error } = await sb.from('ads').select(`
        id,title,description,price,city,category,created_at,
        images,cover_image,is_adult,
        plan_name,plan_price,plan_currency,plan_id,
        contact_name,contact_phone,contact_email,posted_by_email,
        payment_status,paid_at,payment_checked_at
      `).eq('id', id).single();
      if (error) { alert('Грешка при зареждане на обявата.'); return; }

      document.getElementById('mAdTitle').textContent = data.title || '';
      document.getElementById('mMeta').textContent = `${data.city||'—'} · ${data.category||'—'} · ${new Date(data.created_at).toLocaleString('bg-BG')}`;
      document.getElementById('mDesc').textContent = data.description || '';
      const imgs = Array.isArray(data.images) ? data.images : [];
      const mImgs = document.getElementById('mImages'); mImgs.innerHTML = imgs.map(u => `
        <a href="${u}" target="_blank" class="block">
          <img src="${u}" class="w-full h-28 object-cover rounded-lg border">
        </a>`).join('') || '<div class="text-slate-500 text-sm">Няма снимки</div>';

      const currency = (data.plan_currency||'BGN').toUpperCase();
      document.getElementById('mPlan').textContent = data.plan_name || '—';
      document.getElementById('mPrice').textContent = dual(data.plan_price||0, currency);

      const paid = data.payment_status === 'paid' || data.payment_status === 'manual';
      const pill = document.getElementById('mPayStatus');
      pill.textContent = data.payment_status || 'unpaid';
      pill.className = 'inline-block text-xs px-2 py-1 rounded ' + (paid ? 'bg-emerald-100 text-emerald-800' : 'bg-amber-100 text-amber-800');

      const contactHTML = `
        <div><span class="text-slate-500 text-sm">Име:</span> ${esc(data.contact_name||'—')}</div>
        <div><span class="text-slate-500 text-sm">Тел.:</span> ${esc(data.contact_phone||'—')}</div>
        <div><span class="text-slate-500 text-sm">Email:</span> ${esc(data.contact_email||data.posted_by_email||'—')}</div>
      `;
      document.getElementById('mContact').innerHTML = contactHTML;

      // Adult badge
      const isAdult = data?.is_adult === true || /18\+|adult|erot/i.test(data?.category||'');
      document.getElementById('mAdultBadge').classList.toggle('hidden', !isAdult);

      // pay link
      let p = PLAN_MAP[data.plan_id] || PLAN_MAP[(data.plan_name||'').toLowerCase()] || null;
      const payUrl = p?.pay_url?.[(data.plan_currency||'bgn').toLowerCase()] || '#';
      const btnPay = document.getElementById('btnPayLink');
      btnPay.href = payUrl;
      btnPay.classList.toggle('pointer-events-none', !payUrl || payUrl === '#');
      btnPay.classList.toggle('opacity-60', !payUrl || payUrl === '#');

      // Маркирай платено
      const btnPaid = document.getElementById('btnMarkPaid');
      btnPaid.disabled = paid;
      btnPaid.classList.toggle('opacity-50', paid);
      btnPaid.textContent = paid ? 'Платено' : 'Маркирай „платено“';
      btnPaid.onclick = async () => {
        await markPaid(data.id, pill, btnPaid);
        await loadPending();
        await loadAdultPending();
      };

      // approve / reject от модал
      document.getElementById('mApprove').onclick = () => approve(data.id, data.payment_status);
      document.getElementById('mReject').onclick  = () => rejectAd(data.id);

      // show modal
      const m = document.getElementById('modal');
      m.classList.remove('hidden'); m.classList.add('flex');
      document.getElementById('mClose').onclick = () => { m.classList.add('hidden'); m.classList.remove('flex'); };
      m.querySelector('.absolute.inset-0').onclick = () => { m.classList.add('hidden'); m.classList.remove('flex'); };
    }
    window.preview = preview;

    // ====== MARK PAID ======
    async function markPaid(adId, pillEl, btnEl){
      try{
        btnEl.disabled = true;
        btnEl.textContent = 'Маркирам...';
        let rpcErr = null;
        try{
          const { error } = await sb.rpc('mark_ad_paid', { p_ad_id: adId });
          if (error) rpcErr = error;
        }catch(e){ rpcErr = e; }

        if (rpcErr){
          const { error: upErr } = await sb
            .from('ads')
            .update({ payment_status:'paid', paid_at: new Date().toISOString() })
            .eq('id', adId);
          if (upErr) throw upErr;
        }

        pillEl.textContent = 'paid';
        pillEl.className = 'inline-block text-xs px-2 py-1 rounded bg-emerald-100 text-emerald-800';
        btnEl.textContent = 'Платено';
      }catch(err){
        alert('Неуспешна промяна на статус: ' + (err?.message || err));
        btnEl.textContent = 'Маркирай „платено“';
        btnEl.disabled = false;
      }
    }

    // ====== EDIT / HIDE ======
    async function openEdit(id){
      const { data, error } = await sb.from('ads').select('*').eq('id', id).single();
      if (error) { alert('Грешка при зареждане.'); return; }

      byId('eId').value = data.id;
      byId('eTitle').value = data.title || '';
      byId('ePrice').value = Number(data.price||0);
      byId('eCity').value = data.city || '';
      byId('eCategory').value = data.category || '';
      byId('eDesc').value = data.description || '';
      byId('ePlan').value = data.plan_name || '';
      byId('ePlanCur').value = (data.plan_currency||'').toUpperCase();

      const eM = byId('editModal');
      eM.classList.remove('hidden'); eM.classList.add('flex');

      byId('eClose').onclick = () => { eM.classList.add('hidden'); eM.classList.remove('flex'); };
      eM.querySelector('.absolute.inset-0').onclick = () => { eM.classList.add('hidden'); eM.classList.remove('flex'); };

      byId('editForm').onsubmit = async (ev) => {
        ev.preventDefault();
        const payload = {
          title: byId('eTitle').value.trim(),
          price: parseFloat(byId('ePrice').value)||0,
          city: byId('eCity').value.trim(),
          category: byId('eCategory').value.trim(),
          description: byId('eDesc').value,
          plan_name: byId('ePlan').value.trim() || null,
          plan_currency: (byId('ePlanCur').value||'BGN').toUpperCase()
        };
        const { error:updateErr } = await sb.from('ads').update(payload).eq('id', id);
        if (updateErr){ alert('Неуспешно запазване.'); console.error(updateErr); return; }
        eM.classList.add('hidden'); eM.classList.remove('flex');
        await loadApproved();
      };

      byId('eHide').onclick = async () => {
        if (!confirm('Скриване на обявата от сайта?')) return;
        await hideAd(id);
        byId('editModal').classList.add('hidden'); byId('editModal').classList.remove('flex');
      };
    }
    window.openEdit = openEdit;

    async function hideAd(id){
      const { error } = await sb.from('ads').update({ ad_status:'hidden' }).eq('id', id);
      if (error){ alert('Неуспешно премахване.'); console.error(error); return; }
      await loadApproved();
    }
    window.hideAd = hideAd;

    // ====== UTILS ======
    function byId(id){ return document.getElementById(id); }
    function esc(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  </script>
</body>
</html>
