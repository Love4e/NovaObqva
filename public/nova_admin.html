<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NovaObqva — Admin</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="env.js"></script>
</head>
<body class="bg-slate-50 min-h-screen">
  <header class="sticky top-0 bg-white/80 backdrop-blur border-b z-40">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-4">
      <a href="/" class="flex items-center gap-2 text-2xl font-bold">
        <img src="/favicon.png" class="w-6 h-6 rounded" alt=""> NovaObqva
      </a>
      <div class="flex-1"></div>
      <a href="/account.html" class="px-4 py-2 rounded-xl border hover:bg-slate-50">Моят профил</a>
      <button id="logoutBtn" class="px-4 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900">Изход</button>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 md:p-6">
    <h1 class="text-2xl font-bold mb-4">Админ панел</h1>

    <div class="grid lg:grid-cols-3 gap-6">
      <!-- Pending -->
      <section class="lg:col-span-2 bg-white rounded-2xl border p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold">Чакащи обяви</h2>
          <input id="searchEmail" placeholder="търси по имейл…" class="border rounded-lg px-3 py-1.5 text-sm">
        </div>
        <div id="adsPending" class="space-y-3"></div>
      </section>

      <!-- Approved (published) with Edit/Delete -->
      <section class="bg-white rounded-2xl border p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold">Публикувани</h2>
          <select id="approvedLimit" class="border rounded-lg px-2 py-1 text-sm">
            <option value="10">Последни 10</option>
            <option value="25">25</option>
            <option value="50">50</option>
          </select>
        </div>
        <div id="adsApproved" class="space-y-3"></div>
      </section>
    </div>

    <!-- Boosters -->
    <section class="mt-6 bg-white rounded-2xl border p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold">Бустери (чакащи)</h2>
        <div class="text-xs text-slate-500">* Потвърждението бута обявата най-горе за 24 часа.</div>
      </div>
      <div id="boostPending" class="space-y-3"></div>
    </section>
  </main>

  <!-- Preview modal -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative bg-white max-w-3xl w-[90%] rounded-2xl border shadow-lg overflow-hidden">
      <div class="flex items-center justify-between p-4 border-b">
        <div class="font-semibold" id="mTitle">Преглед</div>
        <button id="mClose" class="p-2 rounded-md hover:bg-slate-100">✕</button>
      </div>
      <div class="p-4 grid md:grid-cols-3 gap-4">
        <div class="md:col-span-2 space-y-3">
          <div class="text-xl font-semibold" id="mAdTitle"></div>
          <div class="text-slate-600 text-sm" id="mMeta"></div>
          <div class="text-slate-700 whitespace-pre-wrap" id="mDesc"></div>
          <div id="mImages" class="grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
        </div>
        <aside class="space-y-3">
          <div class="rounded-xl border p-3">
            <div class="text-sm text-slate-500 mb-2">План & плащане</div>
            <div id="mPlan" class="font-medium"></div>
            <div class="text-slate-700" id="mPrice"></div>
            <div class="mt-2">
              <span id="mPayStatus" class="inline-block text-xs px-2 py-1 rounded bg-slate-100"></span>
            </div>
            <div class="mt-3 flex gap-2">
              <button id="btnMarkPaid" class="px-3 py-2 rounded-lg bg-emerald-600 text-white">Маркирай „платено“</button>
              <a id="btnPayLink" target="_blank" class="px-3 py-2 rounded-lg border hover:bg-slate-50">Към плащане</a>
            </div>
          </div>

          <div class="rounded-xl border p-3">
            <div class="text-sm text-slate-500 mb-2">Контакти</div>
            <div id="mContact" class="space-y-1 text-slate-700"></div>
          </div>

          <div class="rounded-xl border p-3">
            <div class="text-sm text-slate-500 mb-2">Действия</div>
            <div class="flex flex-wrap gap-2">
              <button id="mApprove" class="px-3 py-2 bg-emerald-600 text-white rounded-lg">Одобри</button>
              <button id="mReject" class="px-3 py-2 bg-rose-600 text-white rounded-lg">Откажи</button>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <!-- Edit modal -->
  <div id="editModal" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <form id="editForm" class="relative bg-white max-w-2xl w-[92%] rounded-2xl border shadow-lg overflow-hidden">
      <div class="flex items-center justify-between p-4 border-b">
        <div class="font-semibold">Редакция на обява</div>
        <button type="button" id="eClose" class="p-2 rounded-md hover:bg-slate-100">✕</button>
      </div>
      <div class="p-4 grid gap-3">
        <input type="hidden" id="eId">
        <label class="grid gap-1">
          <span class="text-sm text-slate-600">Заглавие</span>
          <input id="eTitle" class="border rounded-lg px-3 py-2" required>
        </label>
        <div class="grid md:grid-cols-3 gap-3">
          <label class="grid gap-1">
            <span class="text-sm text-slate-600">Цена</span>
            <input id="ePrice" type="number" step="0.01" class="border rounded-lg px-3 py-2" required>
          </label>
          <label class="grid gap-1">
            <span class="text-sm text-slate-600">Град</span>
            <input id="eCity" class="border rounded-lg px-3 py-2">
          </label>
          <label class="grid gap-1">
            <span class="text-sm text-slate-600">Категория</span>
            <input id="eCategory" class="border rounded-lg px-3 py-2">
          </label>
        </div>
        <label class="grid gap-1">
          <span class="text-sm text-slate-600">Описание</span>
          <textarea id="eDesc" rows="6" class="border rounded-lg px-3 py-2"></textarea>
        </label>
        <div class="grid md:grid-cols-2 gap-3">
          <label class="grid gap-1">
            <span class="text-sm text-slate-600">План</span>
            <input id="ePlan" class="border rounded-lg px-3 py-2" placeholder="Starter / Pro / Max / Gold">
          </label>
          <label class="grid gap-1">
            <span class="text-sm text-slate-600">Валута на плана</span>
            <input id="ePlanCur" class="border rounded-lg px-3 py-2" placeholder="BGN / EUR">
          </label>
        </div>
        <div class="flex items-center justify-between pt-2">
          <div class="text-xs text-slate-500">* Редакцията е видима веднага.</div>
          <div class="flex gap-2">
            <button type="button" id="eHide" class="px-3 py-2 rounded-lg border text-rose-700 hover:bg-rose-50">Скрий обявата</button>
            <button type="submit" class="px-4 py-2 rounded-lg bg-emerald-600 text-white">Запази</button>
          </div>
        </div>
      </div>
    </form>
  </div>

  <script>
    // ====== CONFIG ======
    const ADMIN_EMAIL = 'uzunov.ange@gmail.com';
    const EXRATE_EUR_BGN = 1.95583; // фиксиран курс
    const sb = supabase.createClient(window.ENV.SUPABASE_URL, window.ENV.SUPABASE_ANON_KEY);

    // Revolut линкове за бустер
    const BOOST_LINK_BGN = 'https://checkout.revolut.com/payment-link/ba2b72d9-8663-4f4e-896d-4a77eaf4f798';
    const BOOST_LINK_EUR = 'https://checkout.revolut.com/payment-link/9f203156-05b6-4ab9-aed1-3c918a22effa';

    // Опции за секция (трябва да съвпадат с CHECK в БД)
    const SECTION_OPTIONS = [
      { v:'main',   t:'Основна' },
      { v:'adult',  t:'18+' },
      { v:'both',   t:'И двете' },
      { v:'hidden', t:'Скрий' },
    ];

    const FALLBACK_PLANS = [
      { id:'starter', name:'Starter', price_bgn:9.99, price_eur:5.10,
        pay_url:{ bgn:'https://checkout.revolut.com/payment-link/b9d03509-71b2-4c35-8d3a-43357e663650',
                  eur:'https://checkout.revolut.com/payment-link/f776550f-0424-4656-aacb-3c1f06c6014b' } },
      { id:'pro', name:'Pro', price_bgn:19.99, price_eur:10.22,
        pay_url:{ bgn:'https://checkout.revolut.com/payment-link/b0cc7f69-9a29-4559-8eed-a06ffc1b2604',
                  eur:'https://checkout.revolut.com/payment-link/62ddc3ea-6192-4b5d-875b-a90d80235edf' } },
      { id:'max', name:'Max', price_bgn:39.99, price_eur:20.45,
        pay_url:{ bgn:'https://checkout.revolut.com/payment-link/e336d64c-7c6a-4962-a7ba-0f9a0e8f3a10',
                  eur:'https://checkout.revolut.com/payment-link/cc4190df-60c1-4f8c-9d3a-c0a949dbb527' } }
    ];
    let PLAN_MAP = {};

    function fmtBGN(n){ try{ return new Intl.NumberFormat('bg-BG',{style:'currency',currency:'BGN'}).format(Number(n)||0); }catch{ return `${Number(n||0).toFixed(2)} лв.`; } }
    function fmtEUR(n){ try{ return new Intl.NumberFormat('bg-BG',{style:'currency',currency:'EUR'}).format(Number(n)||0); }catch{ return `${Number(n||0).toFixed(2)} €`; } }
    function dual(amount, currency){
      const cur = String(currency||'BGN').toUpperCase();
      const val = Number(amount)||0;
      if (cur === 'EUR') return `${fmtEUR(val)}  ·  ${fmtBGN(val*EXRATE_EUR_BGN)}`;
      return `${fmtBGN(val)}  ·  ${fmtEUR(val/EXRATE_EUR_BGN)}`;
    }

    // ====== INIT / GUARD ======
    (async () => {
      const { data:{ user } } = await sb.auth.getUser();
      if (!user) { location.href = 'auth.html?redirectTo=' + encodeURIComponent(location.href); return; }
      if ((user.email||'').toLowerCase() !== ADMIN_EMAIL) { location.href = '/'; return; }

      document.getElementById('logoutBtn').onclick = async () => { await sb.auth.signOut(); location.href='/'; };

      // Plans map
      try {
        const { data, error } = await sb.from('plans').select('id,name,pay_url,price_bgn,price_eur');
        if (!error && data?.length) {
          for (const p of data) {
            let pay = p.pay_url;
            if (typeof pay === 'string') { try{ pay = JSON.parse(pay); }catch{ pay = {}; } }
            PLAN_MAP[p.id] = { ...p, pay_url: pay };
            PLAN_MAP[p.name?.toLowerCase?.()] = PLAN_MAP[p.id];
          }
        }
      } catch(_) {}
      if (Object.keys(PLAN_MAP).length === 0) {
        for (const p of FALLBACK_PLANS) {
          PLAN_MAP[p.id] = p; PLAN_MAP[p.name.toLowerCase()] = p;
        }
      }

      await loadPending();
      await loadApproved();
      await loadBoosters();

      document.getElementById('searchEmail').addEventListener('input', () => loadPending());
      document.getElementById('approvedLimit').addEventListener('change', () => loadApproved());
    })();

    // ====== LOADERS ======
    async function loadPending(){
      const qEmail = document.getElementById('searchEmail').value.trim().toLowerCase();
      let query = sb.from('ads').select(`
          id,title,price,city,category,created_at,
          contact_name,contact_phone,contact_email,posted_by_email,
          plan_name,plan_currency,plan_price,payment_status,
          site_section
        `).eq('ad_status','pending').order('created_at',{ascending:true});
      if (qEmail) query = query.ilike('posted_by_email','%' + qEmail + '%');
      const { data, error } = await query;
      if (error) { console.error(error); alert('Грешка при зареждане на чакащи.'); return; }

      const wrap = document.getElementById('adsPending');
      wrap.innerHTML = (data||[]).map(r => cardPending(r)).join('') || '<p class="text-slate-500">Няма чакащи.</p>';
    }

    async function loadApproved(){
      const limit = Number(document.getElementById('approvedLimit').value || 10);
      const { data, error } = await sb
        .from('ads')
        .select('id,title,price,city,category,approved_at,plan_currency,plan_name,contact_email,images,cover_image,description,site_section,boost_rank')
        .eq('ad_status','approved')
        .order('approved_at',{ascending:false})
        .limit(limit);
      if (error) { console.error(error); return; }

      const wrap = document.getElementById('adsApproved');
      wrap.innerHTML = (data||[]).map(r => cardApproved(r)).join('') || '<p class="text-slate-500">Още няма.</p>';
    }

    // Boosters
    async function loadBoosters(){
      const { data, error } = await sb
        .from('boost_payments')
        .select('id,ad_id,user_id,status,currency,amount_bgn,amount_eur,created_at,confirmed_at,expires_at,note, ads!inner(id,title,city,category,boost_rank)')
        .eq('status','pending')
        .order('created_at',{ascending:true});
      if (error){ console.error(error); return; }
      const wrap = document.getElementById('boostPending');
      wrap.innerHTML = (data||[]).map(cardBooster).join('') || '<p class="text-slate-500">Няма чакащи бустери.</p>';
    }

    // ====== CARDS ======
    function pill(status){
      const paid = status === 'paid' || status === 'manual';
      return `<span class="ml-2 text-xs px-2 py-0.5 rounded ${paid?'bg-emerald-100 text-emerald-800':'bg-amber-100 text-amber-800'}">${esc(status||'unpaid')}</span>`;
    }

    function sectionSelector(id, current){
      const opts = SECTION_OPTIONS
        .map(o => `<option value="${o.v}" ${String(current||'main')===o.v?'selected':''}>${o.t}</option>`)
        .join('');
      return `
        <label class="text-xs text-slate-500 flex items-center gap-2">
          Секция:
          <select class="sectionSel border rounded-md px-2 py-1 text-xs" data-id="${id}">
            ${opts}
          </select>
        </label>`;
    }

    function cardPending(r){
      const currency = (r.plan_currency||'BGN').toUpperCase();
      return `
      <div class="border rounded-xl p-4">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="font-semibold text-lg mb-0.5">${esc(r.title)}</div>
            <div class="text-sm text-slate-500">Създадена: ${new Date(r.created_at).toLocaleString('bg-BG')}</div>
            <div class="text-sm text-slate-500">Потребител: ${esc(r.contact_name||'—')} · ${esc(r.contact_email||r.posted_by_email||'—')} · ${esc(r.contact_phone||'—')}</div>
            <div class="text-sm text-slate-500">Категория: ${esc(r.category||'—')} · Град: ${esc(r.city||'—')}</div>
            <div class="mt-1 flex items-center gap-3 flex-wrap">
              <span class="text-slate-700">План: ${esc(r.plan_name||'—')} · ${dual(r.plan_price||0, currency)}</span>
              ${pill(r.payment_status)}
              ${sectionSelector(r.id, r.site_section)}
            </div>
          </div>
          <div class="flex flex-col items-end gap-2">
            <div class="flex gap-2">
              <button class="px-4 py-2 bg-emerald-600 text-white rounded-xl" onclick="approve('${r.id}', '${r.payment_status||''}')">Одобри</button>
              <button class="px-4 py-2 bg-rose-600 text-white rounded-xl" onclick="rejectAd('${r.id}')">Откажи</button>
              <button class="px-4 py-2 rounded-xl border" onclick="preview('${r.id}')">Виж</button>
            </div>
            <div class="text-emerald-700 font-bold">${fmtBGN(r.price)}</div>
          </div>
        </div>
      </div>`;
    }

    function cardApproved(r){
      const cur = (r.plan_currency||'BGN').toUpperCase();
      const when = r.approved_at ? new Date(r.approved_at).toLocaleString('bg-BG') : '—';
      const boosted = Number(r.boost_rank) === 0;
      return `
      <div class="border rounded-xl p-3">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="font-medium">${esc(r.title)} ${boosted?'<span class="ml-2 text-[10px] font-bold px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-800 align-middle">BUSTER</span>':''}</div>
            <div class="text-xs text-slate-500 flex items-center gap-3 flex-wrap">
              <span>Одобрена: ${when} · ${esc(r.city||'—')} · ${esc(r.category||'—')} · План: ${esc(r.plan_name||'—')} ${cur}</span>
              ${sectionSelector(r.id, r.site_section)}
            </div>
          </div>
          <div class="flex gap-2">
            <button class="px-3 py-1.5 rounded-lg border hover:bg-slate-50" onclick="preview('${r.id}')">Преглед</button>
            <button class="px-3 py-1.5 rounded-lg bg-amber-500 text-white hover:bg-amber-600" onclick="openEdit('${r.id}')">Редакция</button>
            <button class="px-3 py-1.5 rounded-lg bg-rose-600 text-white hover:bg-rose-700" onclick="hideAd('${r.id}')">Премахни</button>
          </div>
        </div>
      </div>`;
    }

    function cardBooster(b){
      const ad = b.ads || {};
      const cur = (b.currency||'BGN').toUpperCase();
      const amountTxt = cur === 'EUR'
        ? `${fmtEUR(b.amount_eur || (8/EXRATE_EUR_BGN))} · ${fmtBGN((b.amount_eur || (8/EXRATE_EUR_BGN)) * EXRATE_EUR_BGN)}`
        : `${fmtBGN(b.amount_bgn || 8)} · ${fmtEUR((b.amount_bgn || 8) / EXRATE_EUR_BGN)}`;
      return `
      <div class="border rounded-xl p-4">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="font-semibold">${esc(ad.title||'—')}</div>
            <div class="text-xs text-slate-500">Обява: ${esc(ad.id||b.ad_id)} · Кат: ${esc(ad.category||'—')} · Град: ${esc(ad.city||'—')} · boost_rank: ${typeof ad.boost_rank==='number'?ad.boost_rank:'—'}</div>
            <div class="text-xs text-slate-500 mt-1">Заявка: ${new Date(b.created_at).toLocaleString('bg-BG')} · Статус: ${esc(b.status||'pending')}</div>
            ${b.note ? `<div class="mt-1 text-xs text-slate-600">Бележка: ${esc(b.note)}</div>`:''}
            <div class="mt-2 font-medium">Сума: ${amountTxt} (${cur})</div>
          </div>
          <div class="flex flex-col items-end gap-2">
            <div class="flex gap-2">
              <a class="px-3 py-2 rounded-lg border hover:bg-slate-50" href="${BOOST_LINK_BGN}" target="_blank">Към плащане BGN</a>
              <a class="px-3 py-2 rounded-lg border hover:bg-slate-50" href="${BOOST_LINK_EUR}" target="_blank">Към плащане EUR</a>
            </div>
            <div class="flex gap-2">
              <button class="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700" onclick="confirmBooster('${b.id}','${b.ad_id}')">Потвърди бустер (24ч)</button>
              <button class="px-3 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-700" onclick="stopBooster('${b.ad_id}','${b.id}')">Спри бустер</button>
            </div>
          </div>
        </div>
      </div>`;
    }

    // Запис на избраната секция
    document.addEventListener('change', async (e)=>{
      const sel = e.target.closest('.sectionSel');
      if (!sel) return;
      const adId = sel.dataset.id;
      const value = sel.value; // main | adult | both | hidden
      sel.disabled = true;
      try{
        // 1) опитай RPC (ако съществува в БД)
        let rpcErr = null;
        try{
          const { error } = await sb.rpc('admin_set_site_section', { p_ad: adId, p_section: value });
          if (error) rpcErr = error;
        }catch(err){ rpcErr = err; }
        // 2) fallback директен update
        if (rpcErr){
          const { error: upErr } = await sb.from('ads').update({ site_section: value }).eq('id', adId);
          if (upErr) throw upErr;
        }
      }catch(err){
        alert('Неуспешна промяна на секцията: ' + (err?.message || err));
      }finally{
        sel.disabled = false;
      }
    });

    // ====== ACTIONS (approve/reject) ======
    async function approve(id, payStatus){
      const { error } = await sb.from('ads').update({ ad_status:'approved', approved_at: new Date().toISOString() }).eq('id', id);
      if (error) { alert('Отказано от сървъра. Нямаш права или грешка.'); console.error(error); return; }
      await loadPending(); await loadApproved();
    }
    async function rejectAd(id){
      if (!confirm('Сигурни ли сте, че отказвате обявата?')) return;
      const { error } = await sb.from('ads').update({ ad_status:'hidden' }).eq('id', id);
      if (error) { alert('Отказано от сървъра. Нямаш права или грешка.'); console.error(error); return; }
      await loadPending();
    }
    window.approve = approve; window.rejectAd = rejectAd;

    // ====== PREVIEW ======
    async function preview(id){
      const { data, error } = await sb.from('ads').select(`
        id,title,description,price,city,category,created_at,
        images,cover_image,
        plan_name,plan_price,plan_currency,plan_id,
        contact_name,contact_phone,contact_email,posted_by_email,
        payment_status,paid_at,payment_checked_at
      `).eq('id', id).single();
      if (error) { alert('Грешка при зареждане на обявата.'); return; }

      document.getElementById('mAdTitle').textContent = data.title || '';
      document.getElementById('mMeta').textContent = `${data.city||'—'} · ${data.category||'—'} · ${new Date(data.created_at).toLocaleString('bg-BG')}`;
      document.getElementById('mDesc').textContent = data.description || '';
      const imgs = Array.isArray(data.images) ? data.images : [];
      const mImgs = document.getElementById('mImages'); mImgs.innerHTML = imgs.map(u => `
        <a href="${u}" target="_blank" class="block">
          <img src="${u}" class="w-full h-28 object-cover rounded-lg border">
        </a>`).join('') || '<div class="text-slate-500 text-sm">Няма снимки</div>';

      const currency = (data.plan_currency||'BGN').toUpperCase();
      document.getElementById('mPlan').textContent = data.plan_name || '—';
      document.getElementById('mPrice').textContent = dual(data.plan_price||0, currency);

      const paid = data.payment_status === 'paid' || data.payment_status === 'manual';
      const pill = document.getElementById('mPayStatus');
      pill.textContent = data.payment_status || 'unpaid';
      pill.className = 'inline-block text-xs px-2 py-1 rounded ' + (paid ? 'bg-emerald-100 text-emerald-800' : 'bg-amber-100 text-amber-800');

      const contactHTML = `
        <div><span class="text-slate-500 text-sm">Име:</span> ${esc(data.contact_name||'—')}</div>
        <div><span class="text-slate-500 text-sm">Тел.:</span> ${esc(data.contact_phone||'—')}</div>
        <div><span class="text-slate-500 text-sm">Email:</span> ${esc(data.contact_email||data.posted_by_email||'—')}</div>
      `;
      document.getElementById('mContact').innerHTML = contactHTML;

      // pay link
      let p = PLAN_MAP[data.plan_id] || PLAN_MAP[(data.plan_name||'').toLowerCase()] || null;
      const payUrl = p?.pay_url?.[(data.plan_currency||'bgn').toLowerCase()] || '#';
      const btnPay = document.getElementById('btnPayLink');
      btnPay.href = payUrl;
      btnPay.classList.toggle('pointer-events-none', !payUrl || payUrl === '#');
      btnPay.classList.toggle('opacity-60', !payUrl || payUrl === '#');

      // Маркирай платено
      const btnPaid = document.getElementById('btnMarkPaid');
      btnPaid.disabled = paid;
      btnPaid.classList.toggle('opacity-50', paid);
      btnPaid.textContent = paid ? 'Платено' : 'Маркирай „платено“';
      btnPaid.onclick = async () => {
        await markPaid(data.id, pill, btnPaid);
        await loadPending();
      };

      document.getElementById('mApprove').onclick = () => approve(data.id, data.payment_status);
      document.getElementById('mReject').onclick  = () => rejectAd(data.id);

      const m = document.getElementById('modal');
      m.classList.remove('hidden'); m.classList.add('flex');
      document.getElementById('mClose').onclick = () => { m.classList.add('hidden'); m.classList.remove('flex'); };
      m.querySelector('.absolute.inset-0').onclick = () => { m.classList.add('hidden'); m.classList.remove('flex'); };
    }
    window.preview = preview;

    // ====== MARK PAID ======
    async function markPaid(adId, pillEl, btnEl){
      try{
        btnEl.disabled = true;
        btnEl.textContent = 'Маркирам...';
        let rpcErr = null;
        try{
          const { error } = await sb.rpc('mark_ad_paid', { p_ad_id: adId });
          if (error) rpcErr = error;
        }catch(e){ rpcErr = e; }

        if (rpcErr){
          const { error: upErr } = await sb
            .from('ads')
            .update({ payment_status:'paid', paid_at: new Date().toISOString() })
            .eq('id', adId);
          if (upErr) throw upErr;
        }

        pillEl.textContent = 'paid';
        pillEl.className = 'inline-block text-xs px-2 py-1 rounded bg-emerald-100 text-emerald-800';
        btnEl.textContent = 'Платено';
      }catch(err){
        alert('Неуспешна промяна на статус: ' + (err?.message || err));
        btnEl.textContent = 'Маркирай „платено“';
        btnEl.disabled = false;
      }
    }

    // ====== BOOSTER ACTIONS ======
    async function confirmBooster(boostId, adId){
      try{
        let rpcErr = null;
        try{
          const { error } = await sb.rpc('admin_confirm_boost', { p_boost_id: boostId, p_ad_id: adId, p_hours: 24 });
          if (error) rpcErr = error;
        }catch(e){ rpcErr = e; }

        if (rpcErr){
          const now = new Date();
          const expires = new Date(now.getTime() + 24*60*60*1000).toISOString();
          const { error: bErr } = await sb.from('boost_payments')
            .update({ status:'confirmed', confirmed_at: now.toISOString(), expires_at: expires })
            .eq('id', boostId);
          if (bErr) throw bErr;
          const { error: aErr } = await sb.from('ads').update({ boost_rank: 0 }).eq('id', adId);
          if (aErr) throw aErr;
        }

        await loadBoosters();
        await loadApproved();
        alert('Бустерът е потвърден за 24 часа.');
      }catch(err){
        console.error(err);
        alert('Неуспешно потвърждаване на бустер: ' + (err?.message || err));
      }
    }
    async function stopBooster(adId, boostId){
      try{
        let rpcErr = null;
        try{
          const { error } = await sb.rpc('admin_stop_boost', { p_boost_id: boostId, p_ad_id: adId });
          if (error) rpcErr = error;
        }catch(e){ rpcErr = e; }

        const { error: aErr } = await sb.from('ads').update({ boost_rank: 999 }).eq('id', adId);
        if (rpcErr){
          try{ await sb.from('boost_payments').update({ status:'canceled' }).eq('id', boostId); }catch(_){}
        }
        if (aErr) throw aErr;

        await loadBoosters();
        await loadApproved();
        alert('Бустерът е спрян.');
      }catch(err){
        console.error(err);
        alert('Неуспешно спиране на бустер: ' + (err?.message || err));
      }
    }
    window.confirmBooster = confirmBooster;
    window.stopBooster = stopBooster;

    // ====== EDIT ======
    async function openEdit(id){
      const { data, error } = await sb.from('ads').select('*').eq('id', id).single();
      if (error) { alert('Грешка при зареждане.'); return; }

      byId('eId').value = data.id;
      byId('eTitle').value = data.title || '';
      byId('ePrice').value = Number(data.price||0);
      byId('eCity').value = data.city || '';
      byId('eCategory').value = data.category || '';
      byId('eDesc').value = data.description || '';
      byId('ePlan').value = data.plan_name || '';
      byId('ePlanCur').value = (data.plan_currency||'').toUpperCase();

      const eM = byId('editModal');
      eM.classList.remove('hidden'); eM.classList.add('flex');

      byId('eClose').onclick = () => { eM.classList.add('hidden'); eM.classList.remove('flex'); };
      eM.querySelector('.absolute.inset-0').onclick = () => { eM.classList.add('hidden'); eM.classList.remove('flex'); };

      byId('editForm').onsubmit = async (ev) => {
        ev.preventDefault();
        const payload = {
          title: byId('eTitle').value.trim(),
          price: parseFloat(byId('ePrice').value)||0,
          city: byId('eCity').value.trim(),
          category: byId('eCategory').value.trim(),
          description: byId('eDesc').value,
          plan_name: byId('ePlan').value.trim() || null,
          plan_currency: (byId('ePlanCur').value||'BGN').toUpperCase()
        };
        const { error:updateErr } = await sb.from('ads').update(payload).eq('id', id);
        if (updateErr){ alert('Неуспешно запазване.'); console.error(updateErr); return; }
        eM.classList.add('hidden'); eM.classList.remove('flex');
        await loadApproved();
      };

      byId('eHide').onclick = async () => {
        if (!confirm('Скриване на обявата от сайта?')) return;
        await hideAd(id);
        byId('editModal').classList.add('hidden'); byId('editModal').classList.remove('flex');
      };
    }
    window.openEdit = openEdit;

    async function hideAd(id){
      const { error } = await sb.from('ads').update({ ad_status:'hidden' }).eq('id', id);
      if (error){ alert('Неуспешно премахване.'); console.error(error); return; }
      await loadApproved();
    }
    window.hideAd = hideAd;

    // ====== UTILS ======
    function byId(id){ return document.getElementById(id); }
    function esc(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  </script>
</body>
</html>
