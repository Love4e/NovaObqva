<!doctype html>
<div>
<label class="block mb-1 font-medium">Имейл</label>
<input name="contact_email" type="email" class="w-full px-4 py-2 rounded-xl border" />
</div>
</div>
<div>
<label class="block mb-1 font-medium">Снимки (до 6)</label>
<input id="photos" type="file" accept="image/*" multiple class="w-full" />
<p class="text-xs text-slate-500 mt-1">Първата снимка ще е корица. Максимум 6 снимки.</p>
</div>
<div class="flex items-center gap-2">
<input id="terms" type="checkbox" required />
<label for="terms" class="text-sm">Съгласен/на съм с общите условия.</label>
</div>
<div class="flex justify-end gap-3">
<a href="/" class="px-4 py-2 rounded-xl border">Отказ</a>
<button class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">Изпрати за одобрение</button>
</div>
</form>
</main>


<script>
async function loadCategories(){
const { data } = await supabaseClient.from('categories').select('id,name').order('name');
const catEl = document.getElementById('cat');
catEl.innerHTML = '<option value="" disabled selected>Избери...</option>' + (data||[]).map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
}


loadCategories();


document.getElementById('form').addEventListener('submit', async (e)=>{
e.preventDefault();
const form = e.currentTarget;
const fd = new FormData(form);
const record = Object.fromEntries(fd.entries());
record.price = Number(record.price||0);
record.status = 'pending';


const { data: ad, error } = await supabaseClient.from('ads').insert(record).select('id').single();
if(error){ alert('Грешка при запис на обявата'); console.error(error); return; }


// качване на снимки
const files = document.getElementById('photos').files;
const MAX = 6;
const toUpload = Array.from(files).slice(0, MAX);
for (const [i,f] of toUpload.entries()){
const ext = f.name.split('.').pop();
const path = `${ad.id}/${crypto.randomUUID()}.${ext}`;
const { error: upErr } = await supabaseClient.storage.from('ad-images').upload(path, f, { upsert:false });
if(upErr){ console.error(upErr); alert('Грешка при качване на снимка'); }
else {
const { data:pub } = supabaseClient.storage.from('ad-images').getPublicUrl(path);
await supabaseClient.from('ad_images').insert({ ad_id: ad.id, url: pub.publicUrl, position: i });
}
}


alert('Обявата е изпратена за одобрение!');
location.href = 'index.html';
});
</script>
</body>
</html>
